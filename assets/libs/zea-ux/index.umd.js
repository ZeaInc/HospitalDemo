!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@zeainc/zea-engine")):"function"==typeof define&&define.amd?define(["exports","@zeainc/zea-engine"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).zeaUx={},e.zeaEngine)}(this,(function(e,t){"use strict";class a extends t.TreeItem{constructor(e){super(e),this.captured=!1,this.colorParam=this.addParameter(new t.ColorParameter("Color",new t.Color)),this.highlightColorParam=this.addParameter(new t.ColorParameter("HighlightColor",new t.Color(1,1,1)))}highlight(){this.emit("highlight")}unhighlight(){this.emit("unhighlight")}getManipulationPlane(){const e=this.getParameter("GlobalXfo").getValue();return new t.Ray(e.tr,e.ori.getZaxis())}onPointerEnter(e){this.highlight()}onPointerLeave(e){this.unhighlight()}onPointerDown(e){e.setCapture(this),e.stopPropagation(),this.captured=!0,e.changedTouches&&this.highlight(),e.viewport?this.handlePointerDown(e):e.vrviewport&&this.onVRControllerButtonDown(e)}onPointerMove(e){this.captured&&(e.stopPropagation(),e.viewport?this.handlePointerMove(e):e.vrviewport&&this.onVRPoseChanged(e)),e.preventDefault()}onPointerUp(e){this.captured&&(e.releaseCapture(),e.stopPropagation(),this.captured=!1,e.changedTouches&&this.unhighlight(),e.viewport?this.handlePointerUp(e):e.vrviewport&&this.onVRControllerButtonUp(e))}onWheel(e){}handlePointerDown(e){this.gizmoRay=this.getManipulationPlane();const t=e.pointerRay,a=t.intersectRayPlane(this.gizmoRay);return e.grabPos=t.pointAtDist(a),this.onDragStart(e),!0}handlePointerMove(e){const t=e.pointerRay,a=t.intersectRayPlane(this.gizmoRay);return e.holdPos=t.pointAtDist(a),this.onDrag(e),!0}handlePointerUp(e){const t=e.pointerRay;if(t){const a=t.intersectRayPlane(this.gizmoRay);e.releasePos=t.pointAtDist(a)}return this.onDragEnd(e),!0}onVRControllerButtonDown(e){this.activeController=e.controller;const t=this.activeController.getTipXfo().clone(),a=this.getManipulationPlane(),s=t.tr.subtract(a.start),n=t.tr.subtract(a.dir.scale(s.dot(a.dir)));return e.grabPos=n,this.onDragStart(e),!0}onVRPoseChanged(e){if(this.activeController){const t=this.activeController.getTipXfo(),a=this.getManipulationPlane(),s=t.tr.subtract(a.start),n=t.tr.subtract(a.dir.scale(s.dot(a.dir)));return e.holdPos=n,this.onDrag(e),!0}}onVRControllerButtonUp(e){if(this.activeController==e.controller){const t=this.activeController.getTipXfo();return this.onDragEnd(e,t.tr),this.activeController=void 0,!0}}onDragStart(e){console.warn("@Handle#onDragStart - Implement me!",e)}onDrag(e){console.warn("@Handle#onDrag - Implement me!",e)}onDragEnd(e){console.warn("@Handle#onDragEnd - Implement me!",e)}}class s extends a{constructor(e){super(e)}handlePointerDown(e){this.gizmoRay=this.getManipulationPlane();const t=e.pointerRay;this.grabDist=t.intersectRayVector(this.gizmoRay)[1];const a=this.gizmoRay.pointAtDist(this.grabDist);return e.grabDist=this.grabDist,e.grabPos=a,this.onDragStart(e),!0}handlePointerMove(e){const t=e.pointerRay.intersectRayVector(this.gizmoRay)[1],a=this.gizmoRay.pointAtDist(t);e.holdDist=t,e.holdPos=a,e.value=t,e.delta=t-this.grabDist,this.onDrag(e)}handlePointerUp(e){const t=e.pointerRay;if(t){const a=t.intersectRayVector(this.gizmoRay)[1],s=this.gizmoRay.pointAtDist(a);e.releasePos=s}return this.onDragEnd(e),!0}onVRControllerButtonDown(e){this.gizmoRay=this.getManipulationPlane(),this.activeController=e.controller;const t=this.activeController.getTipXfo();this.grabDist=t.tr.subtract(this.gizmoRay.start).dot(this.gizmoRay.dir);const a=this.gizmoRay.start.add(this.gizmoRay.dir.scale(this.grabDist));return e.grabPos=a,this.onDragStart(e),!0}onVRPoseChanged(e){const t=this.activeController.getTipXfo().tr.subtract(this.gizmoRay.start).dot(this.gizmoRay.dir),a=this.gizmoRay.start.add(this.gizmoRay.dir.scale(t));return e.value=t,e.holdPos=a,e.delta=t-this.grabDist,this.onDrag(e),!0}onVRControllerButtonUp(e){if(this.activeController==e.controller)return this.onDragEnd(),this.activeController=void 0,!0}}class n extends t.EventEmitter{constructor(){super(),this.__undoStack=[],this.__redoStack=[],this.__currChange=null,this.__currChangeUpdated=this.__currChangeUpdated.bind(this)}flush(){for(const e of this.__undoStack)e.destroy();this.__undoStack=[];for(const e of this.__redoStack)e.destroy();this.__redoStack=[],this.__currChange&&(this.__currChange.off("updated",this.__currChangeUpdated),this.__currChange=null)}addChange(e){this.__currChange&&this.__currChange.off&&this.__currChange.off("updated",this.__currChangeUpdated),this.__undoStack.push(e),this.__currChange=e,this.__currChange.on&&this.__currChange.on("updated",this.__currChangeUpdated);for(const e of this.__redoStack)e.destroy();this.__redoStack=[],this.emit("changeAdded",{change:e})}getCurrentChange(){return this.__currChange}__currChangeUpdated(e){this.emit("changeUpdated",e)}undo(e=!0){if(this.__undoStack.length>0){this.__currChange&&(this.__currChange.off("updated",this.__currChangeUpdated),this.__currChange=null);const t=this.__undoStack.pop();t.undo(),e&&(this.__redoStack.push(t),this.emit("changeUndone"))}}cancel(){if(this.__undoStack.length>0){this.__currChange&&(this.__currChange.off("updated",this.__currChangeUpdated),this.__currChange=null);this.__undoStack.pop().undo()}}redo(){if(this.__redoStack.length>0){const e=this.__redoStack.pop();e.redo(),this.__undoStack.push(e),this.emit("changeRedone")}}constructChange(e){return t.Registry.constructClass(e)}static isChangeClassRegistered(e){try{t.Registry.getBlueprintName(e);return!0}catch(e){return!1}}static getChangeClassName(e){return t.Registry.getBlueprintName(e)}static registerChange(e,a){t.Registry.register(e,a)}static getInstance(){return r||(r=new n),r}}let r;class i extends t.EventEmitter{constructor(e){super(),this.name=e||n.getChangeClassName(this)}undo(){throw new Error("Implement me")}redo(){throw new Error("Implement me")}update(e){throw new Error("Implement me")}toJSON(e){return{}}fromJSON(e,t){}updateFromJSON(e){this.update(e)}destroy(){}}class o extends i{constructor(e,t){e?(super(e?e.getName()+" Changed":"ParameterValueChange"),this.__prevValue=e.getValue(),this.__param=e,null!=t&&(this.__nextValue=t,this.__param.setValue(this.__nextValue))):super(),this.suppressPrimaryChange=!1,this.secondaryChanges=[]}undo(){this.__param&&(this.suppressPrimaryChange||this.__param.setValue(this.__prevValue),this.secondaryChanges.forEach((e=>e.undo())))}redo(){this.__param&&(this.suppressPrimaryChange||this.__param.setValue(this.__nextValue),this.secondaryChanges.forEach((e=>e.redo())))}update(e){this.__param&&(this.__nextValue=e.value,this.__param.setValue(this.__nextValue),this.emit("updated",e))}toJSON(e){const t={name:this.name,paramPath:this.__param.getPath()};return null!=this.__nextValue&&(this.__nextValue.toJSON?t.value=this.__nextValue.toJSON():t.value=this.__nextValue),t}fromJSON(e,a){const s=a.appData.scene.getRoot().resolvePath(e.paramPath,1);s&&s instanceof t.Parameter?(this.__param=s,this.__prevValue=this.__param.getValue(),this.__prevValue.clone?this.__nextValue=this.__prevValue.clone():this.__nextValue=this.__prevValue,this.name=e.name,null!=e.value&&this.updateFromJSON(e)):console.warn("resolvePath is unable to resolve",e.paramPath)}updateFromJSON(e){this.__param&&(this.__nextValue.fromJSON?this.__nextValue.fromJSON(e.value):this.__nextValue=e.value,this.__param.setValue(this.__nextValue))}}n.registerChange("ParameterValueChange",o);class l extends t.GLShader{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=t.shaderLibrary.parseShader("HandleShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\n\n<%include file="GLSLUtils.glsl"/>\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n#ifdef ENABLE_MULTI_DRAW\n<%include file="materialparams.glsl"/>\n#else\nuniform int MaintainScreenSize;\nuniform float Overlay;\n#endif\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  v_drawItemId = float(drawItemId);\n  v_geomItemData  = getInstanceData(drawItemId);\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n\n  //////////////////////////////////////////////\n  // Material\n\n#ifdef ENABLE_MULTI_DRAW\n  vec2 materialCoords = v_geomItemData.zw;\n  vec4 materialValue1 = getMaterialValue(materialCoords, 1);\n  int maintainScreenSize = int(materialValue1.x + 0.5);\n  float overlay = materialValue1.y;\n#else\n  int maintainScreenSize = MaintainScreenSize;\n  float overlay = Overlay;\n#endif\n\n  //////////////////////////////////////////////\n  \n  if (maintainScreenSize != 0) {\n    float dist = modelViewMatrix[3][2];\n    float sc = abs(dist); // Note: items in front of the camera will have a negative value here.\n    mat4 scmat = mat4(\n      sc, 0.0, 0.0, 0.0,\n      0.0, sc, 0.0, 0.0,\n      0.0, 0.0, sc, 0.0,\n      0.0, 0.0, 0.0, 1.0\n    );\n    modelViewMatrix = modelViewMatrix * scmat;\n  }\n\n  vec4 viewPos = modelViewMatrix * vec4(positions, 1.0);\n  gl_Position = projectionMatrix * viewPos;\n\n  if(overlay > 0.0){\n    gl_Position.z = mix(gl_Position.z, -gl_Position.w, overlay);\n  }\n\n  v_viewPos = viewPos.xyz;\n  v_textureCoord = texCoords;\n  v_textureCoord.y = 1.0 - v_textureCoord.y;// Flip y\n}\n'),this.__shaderStages.FRAGMENT_SHADER=t.shaderLibrary.parseShader("HandleShader.fragmentShader",'\nprecision highp float;\n\n<%include file="GLSLUtils.glsl"/>\n<%include file="math/constants.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\n\n#if defined(DRAW_COLOR)\n\nuniform color BaseColor;\n\n#ifdef ENABLE_TEXTURES\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\n#endif\n\n#elif defined(DRAW_GEOMDATA)\n\nuniform int floatGeomBuffer;\nuniform int passId;\n\n<%include file="GLSLBits.glsl"/>\n\n#elif defined(DRAW_HIGHLIGHT)\n\n#ifdef ENABLE_FLOAT_TEXTURES\nvec4 getHighlightColor(int id) {\n  return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 4);\n}\n#else // ENABLE_FLOAT_TEXTURES\n\nuniform vec4 highlightColor;\n\nvec4 getHighlightColor() {\n    return highlightColor;\n}\n\n#endif // ENABLE_FLOAT_TEXTURES\n\n#endif // DRAW_HIGHLIGHT\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  int drawItemId = int(v_drawItemId + 0.5);\n\n  //////////////////////////////////////////////\n  // Color\n#if defined(DRAW_COLOR)\n\n\n#ifdef ENABLE_MULTI_DRAW\n\n  vec2 materialCoords = v_geomItemData.zw;\n  vec4 baseColor = toLinear(getMaterialValue(materialCoords, 0));\n\n#else // ENABLE_MULTI_DRAW\n\n#ifndef ENABLE_TEXTURES\n  vec4 baseColor = toLinear(BaseColor);\n#else\n  vec4 baseColor = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, v_textureCoord);\n#endif // ENABLE_TEXTURES\n\n#endif // ENABLE_MULTI_DRAW\n\n  fragColor = baseColor;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  fragColor.rgb = toGamma(fragColor.rgb);\n#endif\n\n  //////////////////////////////////////////////\n  // GeomData\n#elif defined(DRAW_GEOMDATA)\n\n  float viewDist = length(v_viewPos);\n\n  if(floatGeomBuffer != 0) {\n    fragColor.r = float(passId); \n    fragColor.g = float(v_drawItemId);\n    fragColor.b = 0.0;// TODO: store poly-id or something.\n    fragColor.a = viewDist;\n  } else {\n    ///////////////////////////////////\n    // UInt8 buffer\n    fragColor.r = mod(v_drawItemId, 256.) / 256.;\n    fragColor.g = (floor(v_drawItemId / 256.) + (float(passId) * 64.)) / 256.;\n\n    // encode the dist as a 16 bit float\n    vec2 float16bits = encode16BitFloatInto2xUInt8(viewDist);\n    fragColor.b = float16bits.x;\n    fragColor.a = float16bits.y;\n  }\n\n  //////////////////////////////////////////////\n  // Highlight\n#elif defined(DRAW_HIGHLIGHT)\n  \n  fragColor = getHighlightColor(drawItemId);\n\n#endif // DRAW_HIGHLIGHT\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new t.Color(1,1,.5)}),e.push({name:"MaintainScreenSize",defaultValue:0}),e.push({name:"Overlay",defaultValue:0}),e}static getPackedMaterialData(e){const t=new Float32Array(8),a=e.getParameter("BaseColor").getValue();return t[0]=a.r,t[1]=a.g,t[2]=a.b,t[3]=a.a,t[4]=e.getParameter("MaintainScreenSize").getValue(),t[5]=e.getParameter("Overlay").getValue(),t}static isOverlay(){return!0}}t.Registry.register("HandleShader",l);const h=(e,t)=>{e.update();const a=e.getVertexAttribute("positions");for(let e=0;e<a.length;e++){const s=a.getValueRef(e),n=t.transformVec3(s);s.set(n.x,n.y,n.z)}};class c extends s{constructor(e,a=.1,s=.003,n=new t.Color){super(e),this.colorParam.setValue(n),this.handleMat=new t.Material("handle","HandleShader"),this.handleMat.getParameter("BaseColor").setValue(n),this.handleMat.getParameter("MaintainScreenSize").setValue(1),this.handleMat.getParameter("Overlay").setValue(.9);const r=new t.Cylinder(s,a,64);r.getParameter("BaseZAtZero").setValue(!0);const i=new t.Cone(4*s,10*s,64,!0),o=new t.GeomItem("handle",r,this.handleMat),l=new t.GeomItem("tip",i,this.handleMat),c=new t.Xfo;c.tr.set(0,0,a),h(i,c),this.colorParam.on("valueChanged",(()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())})),this.addChild(o),this.addChild(l)}highlight(){super.highlight(),this.handleMat.getParameter("BaseColor").setValue(this.highlightColorParam.getValue())}unhighlight(){super.unhighlight(),this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.getParameter("GlobalXfo").setValue(e.getValue())};t(),e.on("valueChanged",t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.grabPos=e.grabPos;const t=this.getTargetParam();this.baseXfo=t.getValue(),this.change=new o(t),n.getInstance().addChange(this.change)}onDrag(e){const t=e.holdPos.subtract(this.grabPos),a=this.baseXfo.clone();a.tr.addInPlace(t),this.change.update({value:a})}onDragEnd(e){this.change=null}}class g extends a{constructor(e){super(e)}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.getParameter("GlobalXfo").setValue(e.getValue())};t(),e.on("valueChanged",t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.baseXfo=this.getParameter("GlobalXfo").getValue().clone(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new t.Xfo;const a=this.getTargetParam(),s=a.getValue();this.offsetXfo=this.baseXfo.inverse().multiply(s),this.vec0=e.grabPos.subtract(this.baseXfo.tr),this.grabCircleRadius=this.vec0.length(),this.vec0.normalizeInPlace(),this.change=new o(a),n.getInstance().addChange(this.change)}onDrag(e){const a=e.holdPos.subtract(this.baseXfo.tr);a.normalizeInPlace();let s=1*this.vec0.angleTo(a);if(this.vec0.cross(a).dot(this.baseXfo.ori.getZaxis())<0&&(s=-s),this.range&&(s=t.MathFunctions.clamp(s,this.range[0],this.range[1])),e.shiftKey){const e=Math.degToRad(22.5);s=Math.floor(s/e)*e}this.deltaXfo.ori.setFromAxisAndAngle(new t.Vec3(0,0,1),s);const n=this.baseXfo.multiply(this.deltaXfo).multiply(this.offsetXfo);this.change.update({value:n})}onDragEnd(e){this.change=null}}class u extends g{constructor(e,a,s,n=new t.Color(1,1,0)){super(e),this.radiusParam=this.addParameter(new t.NumberParameter("Radius",a)),this.colorParam.setValue(n),this.handleMat=new t.Material("handle","HandleShader"),this.handleMat.getParameter("BaseColor").setValue(n),this.handleMat.getParameter("MaintainScreenSize").setValue(1),this.handleMat.getParameter("Overlay").setValue(.9);const r=new t.Torus(s,a,64,.5*Math.PI);this.handle=new t.GeomItem("handle",r,this.handleMat),this.handleXfo=new t.Xfo,this.radiusParam.on("valueChanged",(()=>{a=this.radiusParam.getValue(),r.getParameter("OuterRadius").setValue(a),r.getParameter("InnerRadius").setValue(.02*a)})),this.colorParam.on("valueChanged",(()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())})),this.addChild(this.handle)}highlight(){super.highlight(),this.handleMat.getParameter("BaseColor").setValue(this.highlightColorParam.getValue())}unhighlight(){super.unhighlight(),this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}getBaseXfo(){return this.getParameter("GlobalXfo").getValue()}onDragStart(e){super.onDragStart(e)}onDrag(e){super.onDrag(e)}onDragEnd(e){super.onDragEnd(e)}}class d extends a{constructor(e){super(e),this.fullXfoManipulationInVR=!0}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.getParameter("GlobalXfo").setValue(e.getValue())};t(),e.on("valueChanged",t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.grabPos=e.grabPos;const t=this.getTargetParam();this.baseXfo=t.getValue(),this.change=new o(t),n.getInstance().addChange(this.change)}onDrag(e){const t=e.holdPos.subtract(this.grabPos),a=this.baseXfo.clone();a.tr.addInPlace(t),this.change.update({value:a})}onDragEnd(e){this.change=null}onVRControllerButtonDown(e){if(this.fullXfoManipulationInVR){this.activeController=e.controller;const t=this.activeController.getTipXfo(),a=this.getParameter("GlobalXfo").getValue();this.grabOffset=t.inverse().multiply(a)}else super.onVRControllerButtonDown(e);return!0}onVRPoseChanged(e){if(this.fullXfoManipulationInVR){const e=this.activeController.getTipXfo().multiply(this.grabOffset);if(this.change)this.change.update({value:e});else{this.getTargetParam().setValue(e)}}else super.onVRPoseChanged(e)}onVRControllerButtonUp(e){this.fullXfoManipulationInVR?this.change=null:super.onVRControllerButtonUp(e)}}class m extends d{constructor(e,a,s,n=new t.Color){super(e),this.sizeParam=this.addParameter(new t.NumberParameter("Size",a)),this.colorParam.setValue(n),this.handleMat=new t.Material("handle","HandleShader"),this.handleMat.getParameter("BaseColor").setValue(n),this.handleMat.getParameter("MaintainScreenSize").setValue(1),this.handleMat.getParameter("Overlay").setValue(.9);const r=new t.Cuboid(a,a,.02*a),i=new t.Xfo;i.tr=s,h(r,i),this.handle=new t.GeomItem("handle",r,this.handleMat),this.sizeParam.on("valueChanged",(()=>{a=this.sizeParam.getValue(),r.getParameter("X").setValue(a),r.getParameter("Y").setValue(a),r.getParameter("Z").setValue(.02*a)})),this.colorParam.on("valueChanged",(()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())})),this.addChild(this.handle)}highlight(){super.highlight(),this.handleMat.getParameter("BaseColor").setValue(this.highlightColorParam.getValue())}unhighlight(){super.unhighlight(),this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}}class p extends t.TreeItem{constructor(e=.1,s=.003){super("XfoHandle"),this.highlightColorParam=this.addParameter(new t.ColorParameter("HighlightColor",new t.Color(1,1,1))),this.highlightColorParam.on("valueChanged",(()=>{const e=this.highlightColorParam.getValue();this.traverse((t=>{t instanceof a&&t.getParameter("HighlightColor").setValue(e)}))}));const n=new t.TreeItem("Translate");this.addChild(n);const r=new t.Color(1,.1,.1),i=new t.Color("#32CD32"),o=new t.Color("#1E90FF");r.a=1,i.a=1,o.a=1;{const a=new c("linearX",e,s,r),i=new t.Xfo;i.ori.setFromAxisAndAngle(new t.Vec3(0,1,0),.5*Math.PI),a.getParameter("LocalXfo").setValue(i),n.addChild(a)}{const a=new c("linearY",e,s,i),r=new t.Xfo;r.ori.setFromAxisAndAngle(new t.Vec3(1,0,0),-.5*Math.PI),a.getParameter("LocalXfo").setValue(r),n.addChild(a)}{const t=new c("linearZ",e,s,o);n.addChild(t)}const l=.35*e;{const e=new m("planarXY",l,new t.Vec3(.5*l,.5*l,0),o),a=new t.Xfo;e.getParameter("LocalXfo").setValue(a),n.addChild(e)}{const e=new m("planarYZ",l,new t.Vec3(-.5*l,.5*l,0),r),a=new t.Xfo;a.ori.setFromAxisAndAngle(new t.Vec3(0,1,0),.5*Math.PI),e.getParameter("LocalXfo").setValue(a),n.addChild(e)}{const e=new m("planarXZ",l,new t.Vec3(.5*l,.5*l,0),i),a=new t.Xfo;a.ori.setFromAxisAndAngle(new t.Vec3(1,0,0),.5*Math.PI),e.getParameter("LocalXfo").setValue(a),n.addChild(e)}const h=new t.TreeItem("Rotate");this.addChild(h);{const a=new u("rotationX",.75*e,s,r),n=new t.Xfo;n.ori.setFromEulerAngles(new t.EulerAngles(-.5*Math.PI,-.5*Math.PI,0)),a.getParameter("LocalXfo").setValue(n),h.addChild(a)}{const a=new u("rotationY",.75*e,s,i),n=new t.Xfo;n.ori.setFromAxisAndAngle(new t.Vec3(1,0,0),-.5*Math.PI),a.getParameter("LocalXfo").setValue(n),h.addChild(a)}{const a=new u("rotationZ",.75*e,s,o),n=new t.Xfo;n.ori.setFromAxisAndAngle(new t.Vec3(0,0,1),.5*Math.PI),a.getParameter("LocalXfo").setValue(n),h.addChild(a)}}_cleanGlobalXfo(){const e=this.getParentItem();if(void 0!==e){const t=e.getParameter("GlobalXfo").getValue().clone();return t.sc.set(1,1,1),t.multiply(this.__localXfoParam.getValue())}return this.__localXfoParam.getValue()}showHandles(e){this.setVisible(!0)}setTargetParam(e){this.param=e,this.traverse((t=>{t instanceof a&&t.setTargetParam(e,!1)}))}}class f extends t.Operator{constructor(e,a){super(),this.addInput(new t.OperatorInput("InitialXfoMode")).setParam(e),this.addOutput(new t.OperatorOutput("GroupGlobalXfo")).setParam(a),this.currGroupXfo=new t.Xfo}addItem(e){this.addInput(new t.OperatorInput("MemberGlobalXfo"+this.getNumInputs())).setParam(e.getParameter("GlobalXfo")),this.setDirty()}removeItem(e){const t=e.getParameter("GlobalXfo");for(let e=1;e<this.getNumInputs();e++){const a=this.getInputByIndex(e);if(a.getParam()==t)return this.removeInput(a),void this.setDirty()}throw new Error("Item not found in SelectionGroupXfoOperator")}backPropagateValue(e){const t=this.currGroupXfo.inverse(),a=e.multiply(t);a.ori.normalizeInPlace(),this.currGroupXfo=a.multiply(this.currGroupXfo);for(let e=1;e<this.getNumInputs();e++){const t=this.getInputByIndex(e),s=t.getValue(),n=a.multiply(s);t.setValue(n)}}evaluate(){const e=this.getOutput("GroupGlobalXfo");if(this.currGroupXfo=new t.Xfo,1==this.getNumInputs())return void e.setClean(this.currGroupXfo);const a=this.getInput("InitialXfoMode").getValue();if(a!=t.Group.INITIAL_XFO_MODES.manual){if(a==t.Group.INITIAL_XFO_MODES.first){const e=this.getInputByIndex(1).getValue();this.currGroupXfo.tr=e.tr.clone(),this.currGroupXfo.ori=e.ori.clone()}else if(a==t.Group.INITIAL_XFO_MODES.average){this.currGroupXfo.ori.set(0,0,0,0);let e=0;for(let t=1;t<this.getNumInputs();t++){const a=this.getInputByIndex(t).getValue();this.currGroupXfo.tr.addInPlace(a.tr),0==e&&this.currGroupXfo.ori.addInPlace(a.ori),e++}this.currGroupXfo.tr.scaleInPlace(1/e)}else{if(a!=t.Group.INITIAL_XFO_MODES.globalOri)throw new Error("Invalid Group.INITIAL_XFO_MODES.");{let e=0;for(let t=1;t<this.getNumInputs();t++){const a=this.getInputByIndex(t).getValue();this.currGroupXfo.tr.addInPlace(a.tr),e++}this.currGroupXfo.tr.scaleInPlace(1/e)}}this.currGroupXfo.ori.normalizeInPlace(),e.setClean(this.currGroupXfo)}else this.currGroupXfo=e.getValue().clone()}}const P={disabled:0,manual:1,first:2,average:3,globalOri:4};class _ extends t.SelectionSet{constructor(e){let a,s;super(),a=e.selectionOutlineColor?e.selectionOutlineColor:new t.Color(3/255,227/255,172/255,.1),e.branchSelectionOutlineColor?s=e.branchSelectionOutlineColor:(s=a.lerp(new t.Color("white"),.5),s.a=.1),this.getParameter("HighlightColor").setValue(a),this.addParameter(new t.ColorParameter("SubtreeHighlightColor",s)),this.__itemsParam.setFilterFn((e=>e instanceof t.BaseItem)),this.__initialXfoModeParam=this.addParameter(new t.MultiChoiceParameter("InitialXfoMode",P.average,["manual","first","average","global"])),this.selectionGroupXfoOp=new f(this.getParameter("InitialXfoMode"),this.getParameter("GlobalXfo"))}static get INITIAL_XFO_MODES(){return P}clone(){const e=new _;return e.copyFrom(this),e}__bindItem(e,a){if(e instanceof t.TreeItem){const s=this.getParameter("HighlightColor").getValue();s.a=this.getParameter("HighlightFill").getValue(),e.addHighlight("selected"+this.getId(),s,!1);const n=this.getParameter("SubtreeHighlightColor").getValue();e.getChildren().forEach((e=>{e instanceof t.TreeItem&&e.addHighlight("branchselected"+this.getId(),n,!0)})),this.selectionGroupXfoOp.addItem(e,a)}}__unbindItem(e,a){e instanceof t.TreeItem&&(e.removeHighlight("selected"+this.getId()),e.getChildren().forEach((e=>{e instanceof t.TreeItem&&e.removeHighlight("branchselected"+this.getId(),!0)})),this.selectionGroupXfoOp.removeItem(e,a))}}class I extends i{constructor(e,t,a){super("SelectionChange"),this.__selectionManager=e,this.__prevSelection=t,this.__newSelection=a}undo(){this.__selectionManager.setSelection(this.__prevSelection,!1)}redo(){this.__selectionManager.setSelection(this.__newSelection,!1)}toJSON(e){const t=super.toJSON(e),a=[];for(const e of this.__newSelection)a.push(e.getPath());return t.itemPaths=a,t}fromJSON(e,t){super.fromJSON(e,t),this.__selectionManager=t.appData.selectionManager,this.__prevSelection=new Set(this.__selectionManager.getSelection());const a=t.appData.scene.getRoot(),s=new Set;for(const t of e.itemPaths)s.add(a.resolvePath(t,1));this.__newSelection=s,this.__selectionManager.setSelection(this.__newSelection,!1)}}n.registerChange("SelectionChange",I);class C extends i{constructor(e,t){super("Selection Visibility Change"),this.selection=e,this.state=t,this._changeItemsVisibility(this.state)}undo(){this._changeItemsVisibility(!this.state)}redo(){this._changeItemsVisibility(this.state)}_changeItemsVisibility(e){for(const t of this.selection)t.getParameter("Visible").setValue(e)}}n.registerChange("ToggleSelectionVisibility",C);class w extends t.EventEmitter{constructor(e,a={}){if(super(),this.appData=e,this.leadSelection=void 0,this.selectionGroup=new _(a),!0===a.enableXfoHandles){const e=.1,a=.02*e;this.xfoHandle=new p(e,a),this.xfoHandle.setTargetParam(this.selectionGroup.getParameter("GlobalXfo"),!1),this.xfoHandle.setVisible(!1),this.xfoHandle.getParameter("HighlightColor").setValue(new t.Color(1,1,0)),this.xfoHandleVisible=!0,this.selectionGroup.addChild(this.xfoHandle)}this.appData.renderer&&this.setRenderer(this.appData.renderer)}setRenderer(e){this.__renderer!=e?(this.__renderer=e,this.__renderer.addTreeItem(this.selectionGroup)):console.warn("Renderer already set on SelectionManager")}setXfoMode(e){this.xfoHandle&&this.selectionGroup.getParameter("InitialXfoMode").setValue(e)}showHandles(e){this.xfoHandleVisible=e}updateHandleVisibility(){if(!this.xfoHandle)return;const e=this.selectionGroup.getItems(),t=Array.from(e).length>0;this.xfoHandle.setVisible(t&&this.xfoHandleVisible),this.__renderer.requestRedraw()}getSelection(){return this.selectionGroup.getItems()}setSelection(e,t=!0){const a=new Set(this.selectionGroup.getItems()),s=new Set(a);for(const t of e)a.has(t)||(t.setSelected(!0),a.add(t));for(const t of a)e.has(t)||(t.setSelected(!1),a.delete(t));if(this.selectionGroup.setItems(a),a.size>0?this.__setLeadSelection(a.values().next().value):this.__setLeadSelection(),this.updateHandleVisibility(),t){const e=new I(this,s,a);n.getInstance().addChange(e)}this.emit("selectionChanged",{prevSelection:s,selection:a})}__setLeadSelection(e){this.leadSelection!=e&&(this.leadSelection=e,this.emit("leadSelectionChanged",{treeItem:e}))}toggleItemSelection(e,t=!0){const a=new Set(this.selectionGroup.getItems()),s=new Set(a);if(t&&(1!=a.size||!a.has(e))){let t=!0;if(a.has(e)){let s=1;e.traverse((e=>{a.has(e)&&s++})),t=s!=a.size}t&&(Array.from(a).forEach((e=>{e.setSelected(!1)})),a.clear())}let r;a.has(e)?(e.setSelected(!1),a.delete(e),r=!1):(e.setSelected(!0),a.add(e),r=!0),this.selectionGroup.setItems(a),r&&1===a.size?this.__setLeadSelection(e):r||(1===a.size?this.__setLeadSelection(a.values().next().value):0===a.size&&this.__setLeadSelection());const i=new I(this,s,a);n.getInstance().addChange(i),this.updateHandleVisibility(),this.emit("selectionChanged",{prevSelection:s,selection:a})}clearSelection(e=!0){const t=new Set(this.selectionGroup.getItems());if(0==t.size)return!1;let a;e&&(a=new Set(t));for(const e of t)e.setSelected(!1);if(t.clear(),this.selectionGroup.setItems(t),this.updateHandleVisibility(),e){const e=new I(this,a,t);n.getInstance().addChange(e),this.emit("selectionChanged",{selection:t,prevSelection:a})}return!0}selectItems(e,t=!0){const a=new Set(this.selectionGroup.getItems()),s=new Set(a);t&&a.clear();for(const t of e)t.getSelected()||a.add(t);const r=new I(this,s,a);n.getInstance().addChange(r),this.selectionGroup.setItems(a),1===a.size?this.__setLeadSelection(a.values().next().value):0===a.size&&this.__setLeadSelection(),this.updateHandleVisibility(),this.emit("selectionChanged",{prevSelection:s,selection:a})}deselectItems(e){const t=this.selectionGroup.getItems(),a=new Set(t);for(const a of e)a.getSelected()&&(a.setSelected(!1),t.delete(selectedParam));this.selectionGroup.setItems(t);const s=new I(this,a,t);n.getInstance().addChange(s),1===t.size?this.__setLeadSelection(t.values().next().value):0===t.size&&this.__setLeadSelection(),this.updateHandleVisibility(),this.emit("selectionChanged",{prevSelection:a,selection:t})}toggleSelectionVisibility(){if(this.leadSelection){const e=this.selectionGroup.getItems(),t=!this.leadSelection.getVisible(),a=new C(e,t);n.getInstance().addChange(a)}}startPickingMode(e,t,a,s){console.log(e),this.__pickCB=t,this.__pickFilter=a,this.__pickCount=s,this.__picked=[]}pickingFilter(e){return this.__pickFilter(e)}pickingModeActive(){return null!=this.__pickCB}cancelPickingMode(){this.__pickCB=void 0}pick(e){if(this.__pickCB){if(Array.isArray(e))this.__pickFilter?this.__picked=this.__picked.concat(e.filter(this.__pickFilter)):this.__picked=this.__picked.concat(e);else{if(this.__pickFilter&&!this.__pickFilter(e))return;this.__picked.push(e)}this.__picked.length==this.__pickCount&&(this.__pickCB(this.__picked),this.__pickCB=void 0)}}}class v extends i{constructor(e,t,a){e?(super(e.getName()+" Added"),this.treeItem=e,this.owner=t,this.selectionManager=a,this.prevSelection=new Set(this.selectionManager.getSelection()),this.treeItemIndex=this.owner.addChild(this.treeItem),this.selectionManager.setSelection(new Set([this.treeItem]),!1),this.treeItem.addRef(this)):super()}undo(){if(this.treeItem instanceof t.Operator){this.treeItem.detach()}else this.treeItem instanceof t.TreeItem&&this.treeItem.traverse((e=>{if(e instanceof t.Operator){e.detach()}}),!1);this.owner.removeChild(this.treeItemIndex),this.selectionManager&&this.selectionManager.setSelection(this.prevSelection,!1)}redo(){if(this.treeItem instanceof t.Operator){this.treeItem.reattach()}else subTreeItem instanceof t.TreeItem&&this.treeItem.traverse((e=>{if(e instanceof t.Operator){e.reattach()}}),!1);this.owner.addChild(this.treeItem),this.selectionManager&&this.selectionManager.setSelection(new Set([this.treeItem]),!1)}toJSON(e){return{name:this.name,treeItem:this.treeItem.toJSON(e),treeItemPath:this.treeItem.getPath(),treeItemIndex:this.treeItemIndex}}fromJSON(e,a){const s=t.Registry.constructClass(e.treeItem.type);s?(this.name=e.name,this.treeItem=s,this.treeItem.addRef(this),this.treeItem.fromJSON(e.treeItem,a),this.treeItemIndex=this.owner.addChild(this.treeItem,!1,!1)):console.warn("resolvePath is unable to construct",e.treeItem)}destroy(){this.treeItem.removeRef(this)}}n.registerChange("TreeItemAddChange",v);class S extends i{constructor(e,t){e?(super(e.getName()+" Moved"),this.treeItem=e,this.oldOwner=this.treeItem.getOwner(),this.oldOwnerIndex=this.oldOwner.getChildIndex(this.treeItem),this.newOwner=t,this.newOwner.addChild(this.treeItem,!0)):super()}undo(){this.oldOwner.insertChild(this.treeItem,this.oldOwnerIndex,!0)}redo(){this.newOwner.addChild(this.treeItem,!0)}toJSON(e){return{name:this.name,treeItemPath:this.treeItem.getPath(),newOwnerPath:this.newOwner.getPath()}}fromJSON(e,t){const a=appData.scene.getRoot().resolvePath(e.treeItemPath,1);if(!a)return void console.warn("resolvePath is unable to resolve",e.treeItemPath);const s=appData.scene.getRoot().resolvePath(e.newOwnerPath,1);s?(this.name=e.name,this.treeItem=a,this.newOwner=s,this.oldOwner=this.treeItem.getOwner(),this.oldOwnerIndex=this.oldOwner.getChildIndex(this.treeItem),this.newOwner.addChild(this.treeItem,!0)):console.warn("resolvePath is unable to resolve",e.newOwnerPath)}}n.registerChange("TreeItemMoveChange",S);class V extends i{constructor(e,a){if(super(),this.items=[],this.itemOwners=[],this.itemPaths=[],this.itemIndices=[],e){this.selectionManager=a.selectionManager,this.prevSelection=new Set(this.selectionManager.getSelection()),this.items=e,this.newSelection=new Set(this.prevSelection);const s=[];this.items.forEach((e=>{const a=e.getOwner(),n=a.getChildIndex(e);if(s.push(e.getName()),e.addRef(this),this.itemOwners.push(a),this.itemPaths.push(e.getPath()),this.itemIndices.push(n),this.selectionManager&&this.newSelection.has(e)&&this.newSelection.delete(e),e instanceof t.Operator){e.detach()}else e instanceof t.TreeItem&&e.traverse((e=>{if(e instanceof t.Operator){e.detach()}this.selectionManager&&this.newSelection.has(e)&&this.newSelection.delete(e)}),!1);a.removeChild(n)})),this.selectionManager.setSelection(this.newSelection,!1),this.name=s+" Deleted"}}undo(){this.items.forEach(((e,a)=>{if(this.itemOwners[a].insertChild(e,this.itemIndices[a],!1,!1),e instanceof t.Operator){e.reattach()}else subTreeItem instanceof t.TreeItem&&e.traverse((e=>{if(e instanceof t.Operator){e.reattach()}}),!1)})),this.selectionManager&&this.selectionManager.setSelection(this.prevSelection,!1)}redo(){this.selectionManager&&this.selectionManager.setSelection(this.newSelection,!1),this.items.forEach(((e,a)=>{if(this.itemOwners[a].removeChild(this.itemIndices[a]),e instanceof t.Operator){e.detach()}else subTreeItem instanceof t.TreeItem&&e.traverse((e=>{if(e instanceof t.Operator){e.detach()}}),!1)}))}toJSON(e){const t={name:this.name,items:[],itemPaths:this.itemPaths,itemIndices:this.itemIndices};return this.items.forEach((e=>{t.items.push(e.toJSON())})),t}fromJSON(e,t){this.name=e.name,e.itemPaths.forEach((e=>{const a=t.scene.getRoot().resolvePath(e,1);if(!a)return void console.warn("resolvePath is unable to resolve",e);const s=a.getOwner();this.itemOwners.push(s),this.itemPaths.push(a.getPath()),this.itemIndices.push(s.getChildIndex(a))}))}destroy(){this.items.forEach((e=>e.removeRef(this)))}}n.registerChange("TreeItemsRemoveChange",V);class b extends t.BaseTool{constructor(e){super(),e||console.error("App data not provided to tool"),this.appData=e,this.dragging=!1,e.selectionManager||console.error("`SelectionTool` requires `SelectionManager` to be provided in the `appData` object"),this.selectionManager=e.selectionManager,this.selectionRect=new t.Rect(1,1),this.selectionRectMat=new t.Material("marker","ScreenSpaceShader"),this.selectionRectMat.getParameter("BaseColor").setValue(new t.Color("#03E3AC")),this.selectionRectXfo=new t.Xfo,this.selectionRectXfo.tr.set(.5,.5,0),this.selectionRectXfo.sc.set(0,0,0),this.rectItem=new t.GeomItem("selectionRect",this.selectionRect,this.selectionRectMat),this.rectItem.getParameter("Visible").setValue(!1),this.appData.renderer.addTreeItem(this.rectItem)}activateTool(){super.activateTool(),this.prevCursor=this.appData.renderer.getGLCanvas().style.cursor,this.appData.renderer.getGLCanvas().style.cursor="auto"}deactivateTool(){super.deactivateTool(),this.appData.renderer.getGLCanvas().style.cursor=this.prevCursor}setSelectionManager(e){this.selectionManager=e}setSelectionFilter(e){this.__selectionFilterFn=e}activateTool(){super.activateTool()}deactivateTool(){super.deactivateTool(),this.selectionRectXfo.sc.set(0,0,0),this.rectItem.getParameter("GlobalXfo").setValue(this.selectionRectXfo),this.rectItem.getParameter("Visible").setValue(!1)}__resizeRect(e,a){const s=new t.Vec2(1/e.getWidth()*2,1/e.getHeight()*2),n=a.multiply(s);this.selectionRectXfo.sc.set(Math.abs(n.x),Math.abs(n.y),1);const r=this.pointerDownPos.subtract(a.scale(.5)).multiply(s).subtract(new t.Vec2(1,1));this.selectionRectXfo.tr.x=r.x,this.selectionRectXfo.tr.y=-r.y,this.rectItem.getParameter("GlobalXfo").setValue(this.selectionRectXfo)}onPointerDoublePress(e){}onPointerDown(e){("touch"===e.pointerType||0==e.button&&!e.altKey)&&(this.pointerDownPos=e.pointerPos,this.dragging=!1,e.stopPropagation())}onPointerMove(e){if(this.pointerDownPos){const t=this.pointerDownPos.subtract(e.pointerPos);t.length()>4&&(this.dragging=!0,this.rectItem.getParameter("Visible").setValue(!0),this.__resizeRect(e.viewport,t)),e.stopPropagation()}}onPointerUp(e){if(this.pointerDownPos){if(this.dragging){this.rectItem.getParameter("Visible").setValue(!1);const s=e.pointerPos,n=new t.Vec2(Math.min(this.pointerDownPos.x,s.x),Math.min(this.pointerDownPos.y,s.y)),r=new t.Vec2(Math.max(this.pointerDownPos.x,s.x),Math.max(this.pointerDownPos.y,s.y));let i=e.viewport.getGeomItemsInRect(n,r);if(this.__selectionFilterFn){const e=[];for(let t=0;t<i.length;t++){const a=this.__selectionFilterFn(i[t]);e.includes(a)||e.push(a)}i=e}if(!this.selectionManager)throw"Please set the Selection Manager on the Selection Tool before using it.";if(this.selectionManager.pickingModeActive())this.selectionManager.pick(i);else{const t=new Set([...i].filter((e=>!(e.getOwner()instanceof a))));e.shiftKey?this.selectionManager.deselectItems(t):this.selectionManager.selectItems(t,!e.ctrlKey),this.selectionRectXfo.sc.set(0,0,0),this.rectItem.getParameter("GlobalXfo").setValue(this.selectionRectXfo)}}else{const t=e.viewport.getGeomDataAtPos(e.pointerPos);if(null==t||t.geomItem.getOwner()instanceof a)this.selectionManager.clearSelection();else{let a=t.geomItem;if(this.__selectionFilterFn&&(a=this.__selectionFilterFn(a)),this.selectionManager.pickingModeActive())this.selectionManager.pick(a);else if(e.shiftKey){const e=new Set;e.add(a),this.selectionManager.deselectItems(e)}else this.selectionManager.toggleItemSelection(a,!e.ctrlKey)}}this.pointerDownPos=void 0,e.stopPropagation()}}onVRControllerButtonDown(e){if(1==e.button){if(!this.selectionManager)throw"Please set the Selection Manager on the Selection Tool before using it.";const t=e.controller.getGeomItemAtTip();null==t||t.geomItem.getOwner()instanceof a||(this.selectionManager.toggleItemSelection(t.geomItem),e.stopPropagation())}}}const M=function(){return{escape:function(e){return e.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")},parseExtension:e,mimeType:function(t){const a=e(t).toLowerCase();return function(){const e="application/font-woff",t="image/jpeg";return{woff:e,woff2:e,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:t,jpeg:t,gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"}}()[a]||""},dataAsUrl:function(e,t){return"data:"+t+";base64,"+e},isDataUrl:function(e){return-1!==e.search(/^(data:)/)},canvasToBlob:function(e){return e.toBlob?new Promise((function(t){e.toBlob(t)})):function(e){return new Promise((function(t){const a=window.atob(e.toDataURL().split(",")[1]),s=a.length,n=new Uint8Array(s);for(let e=0;e<s;e++)n[e]=a.charCodeAt(e);t(new Blob([n],{type:"image/png"}))}))}(e)},resolveUrl:function(e,t){const a=document.implementation.createHTMLDocument(),s=a.createElement("base");a.head.appendChild(s);const n=a.createElement("a");return a.body.appendChild(n),s.href=t,n.href=e,n.href},getAndEncode:function(e){const t=3e4;x.impl.options.cacheBust&&(e+=(/\?/.test(e)?"&":"?")+(new Date).getTime());return new Promise((function(a){const s=new XMLHttpRequest;let n;if(s.onreadystatechange=r,s.ontimeout=i,s.responseType="blob",s.timeout=t,s.open("GET",e,!0),s.send(),x.impl.options.imagePlaceholder){const e=x.impl.options.imagePlaceholder.split(/,/);e&&e[1]&&(n=e[1])}function r(){if(4!==s.readyState)return;if(200!==s.status)return void(n?a(n):o("cannot fetch resource: "+e+", status: "+s.status));const t=new FileReader;t.onloadend=function(){const e=t.result.split(/,/)[1];a(e)},t.readAsDataURL(s.response)}function i(){n?a(n):o("timeout of "+t+"ms occured while fetching resource: "+e)}function o(e){console.error(e),a("")}}))},uid:function(){let e=0;return function(){return"u"+t()+e++;function t(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}}}(),delay:function(e){return function(t){return new Promise((function(a){setTimeout((function(){a(t)}),e)}))}},asArray:function(e){const t=[],a=e.length;for(let s=0;s<a;s++)t.push(e[s]);return t},escapeXhtml:function(e){return e.replace(/#/g,"%23").replace(/\n/g,"%0A")},makeImage:function(e){return new Promise((function(t,a){const s=new Image;s.onload=function(){t(s)},s.onerror=a,s.src=e}))},width:function(e){const a=t(e,"border-left-width"),s=t(e,"border-right-width");return e.scrollWidth+a+s},height:function(e){const a=t(e,"border-top-width"),s=t(e,"border-bottom-width");return e.scrollHeight+a+s}};function e(e){const t=/\.([^\.\/]*?)$/g.exec(e);return t?t[1]:""}function t(e,t){const a=window.getComputedStyle(e).getPropertyValue(t);return parseFloat(a.replace("px",""))}}(),X=function(){const e=/url\(['"]?([^'"]+?)['"]?\)/g;return{inlineAll:function(e,n,r){return i()?Promise.resolve(e):Promise.resolve(e).then(a).then((function(t){let a=Promise.resolve(e);return t.forEach((function(e){a=a.then((function(t){return s(t,e,n,r)}))})),a}));function i(){return!t(e)}},shouldProcess:t,impl:{readUrls:a,inline:s}};function t(t){return-1!==t.search(e)}function a(t){const a=[];let s;for(;null!==(s=e.exec(t));)a.push(s[1]);return a.filter((function(e){return!M.isDataUrl(e)}))}function s(e,t,a,s){return Promise.resolve(t).then((function(e){return a?M.resolveUrl(e,a):e})).then(s||M.getAndEncode).then((function(e){return M.dataAsUrl(e,M.mimeType(t))})).then((function(a){return e.replace(function(e){return new RegExp("(url\\(['\"]?)("+M.escape(e)+")(['\"]?\\))","g")}(t),"$1"+a+"$3")}))}}(),y=function(){return{resolveAll:function(){return e().then((function(e){return Promise.all(e.map((function(e){return e.resolve()})))})).then((function(e){return e.join("\n")}))},impl:{readAll:e}};function e(){return Promise.resolve(M.asArray(document.styleSheets)).then((function(e){const t=[];return e.forEach((function(e){try{M.asArray(e.cssRules||[]).forEach(t.push.bind(t))}catch(t){console.log("Error while reading CSS rules from "+e.href,t.toString())}})),t})).then((function(e){return e.filter((function(e){return e.type===CSSRule.FONT_FACE_RULE})).filter((function(e){return X.shouldProcess(e.style.getPropertyValue("src"))}))})).then((function(t){return t.map(e)}));function e(e){return{resolve:function(){const t=(e.parentStyleSheet||{}).href;return X.inlineAll(e.cssText,t)},src:function(){return e.style.getPropertyValue("src")}}}}}(),T=function(){return{inlineAll:function t(a){return a instanceof Element?s(a).then((function(){return a instanceof HTMLImageElement?e(a).inline():Promise.all(M.asArray(a.childNodes).map((function(e){return t(e)})))})):Promise.resolve(a);function s(e){const t=e.style.getPropertyValue("background");return t?X.inlineAll(t).then((function(t){e.style.setProperty("background",t,e.style.getPropertyPriority("background"))})).then((function(){return e})):Promise.resolve(e)}},impl:{newImage:e}};function e(e){return{inline:function(t){return M.isDataUrl(e.src)?Promise.resolve():Promise.resolve(e.src).then(t||M.getAndEncode).then((function(t){return M.dataAsUrl(t,M.mimeType(e.src))})).then((function(t){return new Promise((function(a,s){e.onload=a,e.onerror=s,e.src=t}))}))}}}}(),R={imagePlaceholder:void 0,cacheBust:!1},x={toSvg:D,toPng:function(e,t){return O(e,t||{}).then((function(e){return e.toDataURL()}))},toJpeg:function(e,t){return O(e,t=t||{}).then((function(e){return e.toDataURL("image/jpeg",t.quality||1)}))},toBlob:function(e,t){return O(e,t||{}).then(M.canvasToBlob)},toPixelData:function(e,t){return O(e,t||{}).then((function(t){return t.getContext("2d").getImageData(0,0,M.width(e),M.height(e)).data}))},toCanvas:function(e,t){return O(e,t||{}).then((function(e){return e}))},impl:{fontFaces:y,images:T,util:M,inliner:X,options:{}}};function D(e,t){return function(e){void 0===e.imagePlaceholder?x.impl.options.imagePlaceholder=R.imagePlaceholder:x.impl.options.imagePlaceholder=e.imagePlaceholder;void 0===e.cacheBust?x.impl.options.cacheBust=R.cacheBust:x.impl.options.cacheBust=e.cacheBust}(t=t||{}),Promise.resolve(e).then((function(e){return G(e,t.filter,!0)})).then(E).then(A).then((function(e){t.bgcolor&&(e.style.backgroundColor=t.bgcolor);t.width&&(e.style.width=t.width+"px");t.height&&(e.style.height=t.height+"px");t.style&&Object.keys(t.style).forEach((function(a){e.style[a]=t.style[a]}));return e})).then((function(a){return function(e,t,a){return Promise.resolve(e).then((function(e){return e.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),(new XMLSerializer).serializeToString(e)})).then(M.escapeXhtml).then((function(e){return'<foreignObject x="0" y="0" width="100%" height="100%">'+e+"</foreignObject>"})).then((function(e){return'<svg xmlns="http://www.w3.org/2000/svg" width="'+t+'" height="'+a+'">'+e+"</svg>"})).then((function(e){return"data:image/svg+xml;charset=utf-8,"+e}))}(a,t.width||M.width(e),t.height||M.height(e))}))}function O(e,t){return D(e,t).then(M.makeImage).then(M.delay(100)).then((function(a){const s=function(e){const a=document.createElement("canvas");if(a.width=t.width||M.width(e),a.height=t.height||M.height(e),t.bgcolor){const e=a.getContext("2d");e.fillStyle=t.bgcolor,e.fillRect(0,0,a.width,a.height)}return a}(e);return s.getContext("2d").drawImage(a,0,0),s}))}function G(e,t,a){return a||!t||t(e)?Promise.resolve(e).then((function(e){return e instanceof HTMLCanvasElement?M.makeImage(e.toDataURL()):e.cloneNode(!1)})).then((function(a){return function(e,t,a){const s=e.childNodes;return 0===s.length?Promise.resolve(t):n(t,M.asArray(s),a).then((function(){return t}));function n(e,t,a){let s=Promise.resolve();return t.forEach((function(t){s=s.then((function(){return G(t,a)})).then((function(t){t&&e.appendChild(t)}))})),s}}(e,a,t)})).then((function(t){return function(e,t){return t instanceof Element?Promise.resolve().then(a).then(s).then(n).then(r).then((function(){return t})):t;function a(){function a(e,t){function a(e,t){M.asArray(e).forEach((function(a){t.setProperty(a,e.getPropertyValue(a),e.getPropertyPriority(a))}))}e.cssText?t.cssText=e.cssText:a(e,t)}a(window.getComputedStyle(e),t.style)}function s(){function a(a){const s=window.getComputedStyle(e,a),n=s.getPropertyValue("content");if(""===n||"none"===n)return;const r=M.uid();t.className=t.className+" "+r;const i=document.createElement("style");function o(e,t,a){const s="."+e+":"+t,n=a.cssText?r(a):i(a);return document.createTextNode(s+"{"+n+"}");function r(e){const t=e.getPropertyValue("content");return e.cssText+" content: "+t+";"}function i(e){return M.asArray(e).map(t).join("; ")+";";function t(t){return t+": "+e.getPropertyValue(t)+(e.getPropertyPriority(t)?" !important":"")}}}i.appendChild(o(r,a,s)),t.appendChild(i)}[":before",":after"].forEach((function(e){a(e)}))}function n(){e instanceof HTMLTextAreaElement&&(t.innerHTML=e.value),e instanceof HTMLInputElement&&t.setAttribute("value",e.value)}function r(){t instanceof SVGElement&&(t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t instanceof SVGRectElement&&["width","height"].forEach((function(e){const a=t.getAttribute(e);a&&t.style.setProperty(e,a)})))}}(e,t)})):Promise.resolve()}function E(e){return y.resolveAll().then((function(t){const a=document.createElement("style");return e.appendChild(a),a.appendChild(document.createTextNode(t)),e}))}function A(e){return T.inlineAll(e).then((function(){return e}))}function N(e,t,a){if(a(e,t))for(e=e.firstChild;e;)N(e,t+1,a),e=e.nextSibling}const B='data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg"'.length,k=(e,t,a,s)=>{x.toSvg(e).then((e=>{const n=e.substring(0,B)+` viewBox="0 0 ${t.width} ${t.height}"`+e.substring(B),r=new Image;r.onload=function(){s(r,a)},r.src=n}))},L=new t.Plane(1,1);class H extends t.TreeItem{constructor(e,a){super("VRControllerUI"),this.setSelectable(!1),this.appData=e,this.__vrUIDOMElement=a,this.__vrUIDOMElement.style.display="none";const s=new t.TreeItem("Offset");this.addChild(s,!1),this.ready=!1;const n=new ResizeObserver((e=>{n.disconnect();const r=new t.Xfo,i=5e-4;r.sc.set(i,i,i),r.ori.setFromEulerAngles(new t.EulerAngles(Math.PI,Math.PI,0)),s.getParameter("LocalXfo").setValue(r),this.size=new t.Vec3(a.clientWidth*i,a.clientHeight*i,1),N(a,0,((e,n)=>{if("button"==e.className){const r=function(e){const t=e.computedStyleMap();return{width:t.get("width").value+(t.get("margin-left").value+t.get("margin-right").value),height:t.get("height").value+(t.get("margin-top").value+t.get("margin-bottom").value)}}(e),i=new t.Xfo;i.sc.set(r.width,-r.height,1),i.tr.set(e.offsetLeft+.5*r.width-.5*a.clientWidth,e.offsetTop+.5*r.height-.5*a.clientHeight,-n);const o=new t.Material("element-vr-ui-mat","FlatSurfaceShader");o.getParameter("BaseColor").setValue(new t.Color(.3,.3,.3));const l=new t.DataImage;o.getParameter("BaseColor").setValue(l);const h=new t.GeomItem("element-vr-ui",L,o,i);h.setSelectable(!1),s.addChild(h,!1);const c={};r.width>0&&r.height>0&&k(e,r,e.id+e.className,((e,t)=>{c[t]=e,l.setData(r.width,r.height,e)}));return new MutationObserver((t=>{if(0==r.width||0==r.height)return;const a=e.id+e.className;c[a]?l.setData(r.width,r.height,c[a]):k(e,r,a,((e,t)=>{c[t]=e,l.setData(r.width,r.height,e)}))})).observe(e,{attributes:!0,characterData:!1,childList:!1,subtree:!1}),!1}return!0})),this.ready=!0,this.emit("ready")}));n.observe(a)}activate(){this.__vrUIDOMElement.style.display="block"}deactivate(){this.__vrUIDOMElement.style.display="none"}sendMouseEvent(e,t,a){const s=new MouseEvent(e,Object.assign({target:a,view:window,bubbles:!0,cancelable:!0},t));return a.dispatchEvent(s),s}}class U extends t.BaseTool{constructor(e,a){super(e),this.appData=e,this.__vrUIDOMElement=a,this.controllerUI=new H(e,this.__vrUIDOMElement);const s=new t.Material("pointermat","LinesShader");s.setSelectable(!1),s.getParameter("BaseColor").setValue(new t.Color(1.2,0,0));const n=new t.Lines;n.setNumVertices(2),n.setNumSegments(1),n.setSegmentVertexIndices(0,0,1);const r=n.getVertexAttribute("positions");r.getValueRef(0).set(0,0,0),r.getValueRef(1).set(0,0,-1),n.setBoundingBoxDirty(),this.__pointerLocalXfo=new t.Xfo,this.__pointerLocalXfo.sc.set(1,1,.1),this.__pointerLocalXfo.ori.setFromAxisAndAngle(new t.Vec3(1,0,0),-.2*Math.PI),this.__uiPointerItem=new t.GeomItem("VRControllerPointer",n,s),this.__uiPointerItem.setSelectable(!1),this.__triggerHeld=!1,this.uiOpen=!1,this.appData.renderer.getXRViewport().then((e=>{e.on("presentingChanged",(e=>{this.uiOpen&&!e.state&&this.closeUI()}))}))}getName(){return"VRUITool"}activateTool(){super.activateTool()}deactivateTool(){this.uiOpen&&this.closeUI(),super.deactivateTool()}displayUI(e,a,s){this.controllerUI.activate(),this.uiController=e,this.pointerController=a;const n=this.controllerUI.getParameter("LocalXfo").getValue();if(n.ori.setFromAxisAndAngle(new t.Vec3(1,0,0),-.6*Math.PI),this.pointerController){const e=this.uiController.getTreeItem().getParameter("GlobalXfo").getValue(),t=this.pointerController.getTreeItem().getParameter("GlobalXfo").getValue(),a=e.tr.subtract(s.tr),r=t.tr.subtract(s.tr);a.cross(r).dot(s.ori.getYaxis())>0?n.tr.set(.05,-.05,.08):n.tr.set(-.05,-.05,.08)}else n.tr.set(0,-.05,.08);if(this.controllerUI.getParameter("LocalXfo").setValue(n),this.uiController&&(this.uiController.getTipItem().addChild(this.controllerUI,!1),this.pointerController&&this.pointerController.getTipItem().addChild(this.__uiPointerItem,!1),this.appData.session)){const e=()=>{this.appData.session.pub("pose-message",{interfaceType:"VR",showUIPanel:{controllerId:this.uiController.getId(),localXfo:n.toJSON(),size:this.controllerUI.size.toJSON()}})};this.controllerUI.ready?e():this.controllerUI.on("ready",e)}this.uiOpen=!0}closeUI(){this.controllerUI.deactivate(),this.uiController&&(this.uiController.getTipItem().removeChildByHandle(this.controllerUI),this.pointerController&&this.pointerController.getTipItem().removeChildByHandle(this.__uiPointerItem),this.appData.session&&this.appData.session.pub("pose-message",{interfaceType:"VR",closehideUIPanel:{controllerId:this.uiController.getId()}})),this.uiOpen=!1}setPointerLength(e){this.__pointerLocalXfo.sc.set(1,1,e),this.__uiPointerItem.getParameter("LocalXfo").setValue(this.__pointerLocalXfo)}calcUIIntersection(){const e=this.__uiPointerItem.getParameter("GlobalXfo").getValue(),a=e.ori.getZaxis().negate(),s=new t.Ray(e.tr,a),n=this.controllerUI.getParameter("GlobalXfo").getValue(),r=this.controllerUI.size.multiply(n.sc),i=new t.Ray(n.tr,n.ori.getZaxis().negate()),o=s.intersectRayPlane(i);if(o<=0)return void this.setPointerLength(.5);const l=e.tr.add(a.scale(o)).subtract(i.start),h=l.dot(n.ori.getXaxis())/r.x,c=l.dot(n.ori.getYaxis())/r.y;if(Math.abs(h)>.5||Math.abs(c)>.5)return void this.setPointerLength(.5);this.setPointerLength(o/n.sc.z);const g=this.__vrUIDOMElement.getBoundingClientRect();return{clientX:Math.round(h*-g.width+g.width/2),clientY:Math.round(c*-g.height+g.height/2)}}sendEventToUI(e,t){const a=this.calcUIIntersection();if(a){a.offsetX=a.pageX=a.pageX=a.screenX=a.clientX,a.offsetY=a.pageY=a.pageY=a.screenY=a.clientY;let s=document.elementFromPoint(a.clientX,a.clientY);return s?(s.shadowRoot&&(s=s.shadowRoot.elementFromPoint(a.clientX,a.clientY)),s!=this._element&&(this._element&&this.controllerUI.sendMouseEvent("mouseleave",Object.assign(t,a),this._element),this._element=s,this.controllerUI.sendMouseEvent("mouseenter",Object.assign(t,a),this._element)),this.controllerUI.sendMouseEvent(e,Object.assign(t,a),this._element)):this._element=null,this._element}this._element&&(this.controllerUI.sendMouseEvent("mouseleave",Object.assign(t,a),this._element),this._element=null)}onPointerDown(e){if(e.pointerType===t.POINTER_TYPES.xr&&e.controller==this.pointerController&&this.uiOpen){this.__triggerHeld=!0;const t=this.sendEventToUI("mousedown",{button:e.button-1});this.__triggerDownElem=t||null,e.stopPropagation()}}onPointerUp(e){if(e.pointerType===t.POINTER_TYPES.xr&&e.controller==this.pointerController&&this.uiOpen){this.__triggerHeld=!1;const t=this.sendEventToUI("mouseup",{button:e.button-1});t&&this.__triggerDownElem==t&&this.sendEventToUI("mouseup",{button:e.button-1}),this.__triggerDownElem=null,e.stopPropagation()}}onPointerMove(e){if(e.pointerType===t.POINTER_TYPES.xr)if(this.uiOpen){const t=e.viewXfo;(()=>{const a=this.uiController.getTreeItem().getParameter("GlobalXfo").getValue(),s=a.tr.subtract(t.tr);return s.normalizeInPlace(),!(s.angleTo(a.ori.getYaxis())>.5*Math.PI)||(this.closeUI(),e.getCapture()==this&&e.releaseCapture(this),!1)})()&&this.sendEventToUI("mousemove",{}),e.stopPropagation()}else{if(!e.controllers[0]||e.controllers[0].buttonPressed||!e.controllers[1]||e.controllers[1].buttonPressed)return;const t=e.viewXfo,a=(a,s)=>{const n=a.getTreeItem().getParameter("GlobalXfo").getValue(),r=n.tr.subtract(t.tr);return r.normalizeInPlace(),r.angleTo(n.ori.getYaxis())<.25*Math.PI&&(this.displayUI(a,s,t),e.setCapture(this),e.stopPropagation(),!0)};if(a(e.controllers[0],e.controllers[1]))return;if(a(e.controllers[1],e.controllers[0]))return}}}class z extends i{constructor(e){super("HoldObjectsChange"),this.__selection=[],this.__prevXfos=[],this.__newXfos=[],e&&this.update(e)}undo(){for(let e=0;e<this.__selection.length;e++)this.__selection[e]&&this.__prevXfos[e]&&this.__selection[e].getParameter("GlobalXfo").setValue(this.__prevXfos[e])}redo(){for(let e=0;e<this.__selection.length;e++)this.__selection[e]&&this.__newXfos[e]&&this.__selection[e].getParameter("GlobalXfo").setValue(this.__newXfos[e])}update(e){if(e.newItem)this.__selection[e.newItemId]=e.newItem,this.__prevXfos[e.newItemId]=e.newItem.getParameter("GlobalXfo").getValue();else if(e.changeXfos)for(let t=0;t<e.changeXfoIds.length;t++){const a=e.changeXfoIds[t];this.__selection[a]&&(this.__selection[a].getParameter("GlobalXfo").setValue(e.changeXfos[t]),this.__newXfos[a]=e.changeXfos[t])}this.emit("updated",e)}toJSON(e){const t=super.toJSON(e),a=[];for(let e=0;e<this.__selection.length;e++)this.__selection[e]?a[e]=this.__selection[e].getPath():a.push(null);return t.itemPaths=a,t}fromJSON(e,t){super.fromJSON(e,t);const a=t.appData.scene.getRoot();this.__selection=[];for(let t=0;t<e.itemPaths.length;t++){const s=e.itemPaths[t];if(s&&""!=s){const e=a.resolvePath(s,1);e!=a&&(this.__selection[t]=e,this.__prevXfos[t]=e.getParameter("GlobalXfo").getValue())}}}updateFromJSON(e){this.update(e)}}n.registerChange("HoldObjectsChange",z);class F extends t.BaseTool{constructor(e){super(e),this.appData=e,this.__pressedButtonCount=0,this.__freeIndices=[],this.__vrControllers=[],this.__heldObjectCount=0,this.__heldGeomItems=[],this.__highlightedGeomItemIds=[],this.__heldGeomItemIds=[],this.__heldGeomItemRefs=[],this.__heldGeomItemOffsets=[]}activateTool(){super.activateTool(),this.appData.renderer.getGLCanvas().style.cursor="crosshair";const e=e=>{this.__activated};this.appData.renderer.getXRViewport().then((t=>{for(const a of t.getControllers())e();this.addIconToControllerId=t.on("controllerAdded",(t=>e(t.controller)))}))}deactivateTool(){super.deactivateTool(),this.appData.renderer.getXRViewport().then((e=>{e.removeListenerById("controllerAdded",this.addIconToControllerId)}))}computeGrabXfo(e){let a;if(1==e.length)a=this.__vrControllers[e[0]].getTipXfo();else if(2==e.length){const s=this.__vrControllers[e[0]].getTipXfo(),n=this.__vrControllers[e[1]].getTipXfo();s.ori.alignWith(n.ori),a=new t.Xfo,a.tr=s.tr.lerp(n.tr,.5),a.ori=s.ori.lerp(n.ori,.5);let r=n.tr.subtract(s.tr);r.normalizeInPlace();const i=a.ori.getXaxis();r.dot(i)<0&&(r=r.negate());const o=r.angleTo(i);if(o>0){const e=i.cross(r);e.normalizeInPlace();const s=new t.Quat;s.setFromAxisAndAngle(e,o),a.ori=s.multiply(a.ori)}}return a}initAction(){for(let e=0;e<this.__heldGeomItems.length;e++){const t=this.__heldGeomItems[e];if(!t)continue;const a=this.computeGrabXfo(this.__heldGeomItemRefs[e]);this.__heldGeomItemOffsets[e]=a.inverse().multiply(t.getParameter("GlobalXfo").getValue())}}onPointerDown(e){if(e.pointerType===t.POINTER_TYPES.xr){const t=e.controller.getId();this.__vrControllers[t]=e.controller;const a=this.__highlightedGeomItemIds[t];if(a){let s=this.__heldGeomItems.indexOf(a);if(-1==s){s=this.__heldGeomItems.length,this.__heldObjectCount++,this.__heldGeomItems.push(a),this.__heldGeomItemRefs[s]=[t],this.__heldGeomItemIds[t]=s;const e={newItem:a,newItemId:s};this.change?this.change.update(e):(this.change=new z(e),n.getInstance().addChange(this.change))}else this.__heldGeomItemIds[t]=s,this.__heldGeomItemRefs[s].push(t);this.initAction(),e.stopPropagation()}}}onPointerUp(e){if(e.pointerType===t.POINTER_TYPES.xr){const t=e.controller.getId();if(this.__pressedButtonCount--,void 0!==this.__heldGeomItemIds[t]){const a=this.__heldGeomItemIds[t],s=this.__heldGeomItemRefs[a];s.splice(s.indexOf(t),1),0==s.length&&(this.__heldObjectCount--,this.__heldGeomItems[a]=void 0,this.change=void 0),this.__heldGeomItemIds[t]=void 0,this.initAction(),e.stopPropagation()}}}onPointerMove(e){if(e.pointerType===t.POINTER_TYPES.xr){if(!this.change)return void e.controllers.forEach((e=>{const a=e.getId(),s=e.getGeomItemAtTip();if(s){const e=s.geomItem;this.__highlightedGeomItemIds[a]!=e&&(this.__highlightedGeomItemIds[a]&&this.__highlightedGeomItemIds[a].removeHighlight("vrHoldObject"),e.addHighlight("vrHoldObject",new t.Color(1,0,0,.2)),this.__highlightedGeomItemIds[a]=e)}else if(this.__highlightedGeomItemIds[a]){this.__highlightedGeomItemIds[a].removeHighlight("vrHoldObject"),this.__highlightedGeomItemIds[a]=null}}));const a=[],s=[];for(let e=0;e<this.__heldGeomItems.length;e++){if(!this.__heldGeomItems[e])continue;const t=this.computeGrabXfo(this.__heldGeomItemRefs[e]);a.push(t.multiply(this.__heldGeomItemOffsets[e])),s.push(e)}this.change.update({changeXfos:a,changeXfoIds:s}),e.stopPropagation()}}onPointerDoublePress(e){e.pointerType,t.POINTER_TYPES.xr}}class J extends t.BaseTool{constructor(e){super(e)}isPrimaryTool(){return!0}}class j extends J{constructor(e){super(e),e||console.error("App data not provided to tool"),this.appData=e,this.stage=0,this.removeToolOnRightClick=!0,this.parentItem="parentItem"in e?e.parentItem:e.scene.getRoot(),this.colorParam=this.addParameter(new t.ColorParameter("Color",new t.Color(.7,.2,.2))),this.controllerAddedHandler=this.controllerAddedHandler.bind(this)}addIconToVRController(e){this.vrControllerToolTip||(this.vrControllerToolTip=new t.Cross(.05),this.vrControllerToolTipMat=new t.Material("VRController Cross","LinesShader"),this.vrControllerToolTipMat.getParameter("BaseColor").setValue(this.colorParam.getValue()),this.vrControllerToolTipMat.setSelectable(!1));const a=new t.GeomItem("CreateGeomToolTip",this.vrControllerToolTip,this.vrControllerToolTipMat);a.setSelectable(!1),e.getTipItem().addChild(a,!1)}controllerAddedHandler(e){this.addIconToVRController(e.controller)}activateTool(){super.activateTool(),this.prevCursor=this.appData.renderer.getGLCanvas().style.cursor,this.appData.renderer.getGLCanvas().style.cursor="crosshair",this.appData.renderer.getXRViewport().then((e=>{for(const t of e.getControllers())this.addIconToVRController(t);e.on("controllerAdded",this.controllerAddedHandler)}))}deactivateTool(){super.deactivateTool(),this.appData.renderer.getGLCanvas().style.cursor=this.prevCursor,this.appData.renderer.getXRViewport().then((e=>{e.off("controllerAdded",this.controllerAddedHandler)}))}screenPosToXfo(e){const a=e.pointerRay,s=new t.Ray(this.constructionPlane.tr,this.constructionPlane.ori.getZaxis()),n=a.intersectRayPlane(s);if(n>0){const e=this.constructionPlane.clone();return e.tr=a.pointAtDist(n),e}const r=e.viewport.getCamera(),i=r.getParameter("GlobalXfo").getValue().clone();return i.tr=a.pointAtDist(r.getFocalDistance()),i}createStart(e){this.stage=1}createPoint(e){}createMove(e){}createRelease(e){}onPointerDown(e){if(e.pointerType===t.POINTER_TYPES.xr)this.onVRControllerButtonDown(e);else{if(e.altKey)return;if(0==this.stage)if(0==e.button||"mouse"!==e.pointerType){this.constructionPlane=new t.Xfo;const a=this.screenPosToXfo(e);this.createStart(a),e.stopPropagation()}else e.button;else 2==e.button&&(n.getInstance().cancel(),this.stage=0)}e.stopPropagation()}onPointerMove(e){if(e.pointerType===t.POINTER_TYPES.xr)this.onVRPoseChanged(e);else if(this.stage>0){const t=this.screenPosToXfo(e);this.createMove(t.tr),e.stopPropagation()}}onPointerUp(e){if(e.pointerType===t.POINTER_TYPES.xr)this.onVRControllerButtonUp(e);else if(this.stage>0){const t=this.screenPosToXfo(e);this.createRelease(t.tr),e.stopPropagation()}}onWheel(e){}onKeyPressed(e){}onKeyDown(e){}onKeyUp(e){}onTouchCancel(e){}onVRControllerButtonDown(e){if(!this.__activeController){this.__activeController=e.controller,this.constructionPlane=new t.Xfo;const a=this.constructionPlane.clone();a.tr=this.__activeController.getTipXfo().tr,this.createStart(a,this.appData.scene.getRoot())}e.stopPropagation()}onVRPoseChanged(e){if(this.__activeController&&this.stage>0){const t=this.__activeController.getTipXfo();this.createMove(t.tr),e.stopPropagation()}}onVRControllerButtonUp(e){if(this.stage>0&&this.__activeController==e.controller){const t=this.__activeController.getTipXfo();this.createRelease(t.tr),0==this.stage&&(this.__activeController=void 0),e.stopPropagation()}}}class Y extends i{constructor(e){super(e)}setParentAndXfo(e,t){this.parentItem=e;const a=this.parentItem.generateUniqueName(this.geomItem.getName());this.geomItem.setName(a),this.geomItem.getParameter("GlobalXfo").setValue(t),this.parentItem.addChild(this.geomItem)}undo(){this.parentItem.removeChild(this.parentItem.getChildIndex(this.geomItem))}redo(){this.parentItem.addChild(this.geomItem,!1,!1)}toJSON(e){const t=super.toJSON(e);t.parentItemPath=this.parentItem.getPath(),t.geomItemName=this.geomItem.getName(),t.geomItemXfo=this.geomItem.getParameter("LocalXfo").getValue();const a=this.geomItem.getParameter("Material").getValue();return t.color=a.getParameter("BaseColor").getValue(),t}fromJSON(e,a){const s=a.appData.scene.getRoot();this.parentItem=s.resolvePath(e.parentItemPath,1),this.geomItem.setName(this.parentItem.generateUniqueName(e.geomItemName));const n=new t.Xfo;if(n.fromJSON(e.geomItemXfo),this.geomItem.getParameter("LocalXfo").setValue(n),this.childIndex=this.parentItem.addChild(this.geomItem,!1),e.color){const a=new t.Color(.7,.2,.2);a.fromJSON(e.color);this.geomItem.getParameter("Material").getValue().getParameter("BaseColor").setValue(a)}}destroy(){}}class W extends Y{constructor(e,a,s,n){super("Create Line"),this.line=new t.Lines(0),this.line.setNumVertices(2),this.line.setNumSegments(1),this.line.setSegmentVertexIndices(0,0,1);const r=new t.Material("Line","FatLinesShader");r.getParameter("BaseColor").setValue(new t.Color(.7,.2,.2)),this.geomItem=new t.GeomItem("Line",this.line,r),s&&r.getParameter("BaseColor").setValue(s),n&&(this.line.lineThickness=n),e&&a&&this.setParentAndXfo(e,a)}update(e){e.p1&&(this.line.getVertexAttribute("positions").getValueRef(1).setFromOther(e.p1),this.line.emit("geomDataChanged")),this.emit("updated",e)}fromJSON(e,a){if(super.fromJSON(e,a),e.color){const a=new t.Color;a.fromJSON(e.color),material.getParameter("BaseColor").setValue(a)}e.thickness&&(this.line.lineThickness=e.thickness)}}n.registerChange("CreateLineChange",W);class K extends j{constructor(e){super(e),this.lineThickness=this.addParameter(new t.NumberParameter("LineThickness",.01,[0,.1]))}createStart(e){this.change=new W(this.parentItem,e),n.getInstance().addChange(this.change),this.xfo=e.inverse(),this.stage=1,this.length=0}createMove(e){const t=this.xfo.transformVec3(e);this.length=t.length(),this.change.update({p1:t})}createRelease(e){0==this.length&&n.getInstance().cancel(),this.stage=0,this.emit("actionFinished")}onVRControllerButtonDown(e){if(0==this.stage){const t=e.viewport.__stageScale;this.lineThickness.setValue(.003*t)}super.onVRControllerButtonDown(e)}}class Z extends Y{constructor(e,a,s){super("Create Cone");const n=new t.Cone(0,0),r=new t.Material("Cone","SimpleSurfaceShader");this.geomItem=new t.GeomItem("Cone",n,r),e&&a&&(r.getParameter("BaseColor").setValue(s),this.setParentAndXfo(e,a))}update(e){e.radius&&this.geomItem.getParameter("Geometry").getValue().getParameter("Radius").setValue(e.radius),e.height&&this.geomItem.getParameter("Geometry").getValue().getParameter("Height").setValue(e.height),this.emit("updated",e)}}n.registerChange("CreateConeChange",Z);class $ extends Y{constructor(e,a){super("CreateCircle"),this.circle=new t.Circle(0,64),this.circle.lineThickness=.05;const s=new t.Material("circle","FatLinesShader");s.getParameter("BaseColor").setValue(new t.Color(.7,.2,.2)),this.geomItem=new t.GeomItem("Circle",this.circle,s),e&&a&&this.setParentAndXfo(e,a)}update(e){this.circle.getParameter("Radius").setValue(e.radius),this.emit("updated",e)}toJSON(){const e=super.toJSON();return e.radius=this.circle.getParameter("Radius").getValue(),e}updateFromJSON(e){console.log("CreateCircleChange:",e),e.radius&&this.circle.getParameter("Radius").setValue(e.radius)}}n.registerChange("CreateCircleChange",$);class q extends Y{constructor(e,a){super("CreateRect"),this.rect=new t.Rect(0,0),this.rect.lineThickness=.05;const s=new t.Material("circle","FatLinesShader");s.getParameter("BaseColor").setValue(new t.Color(.7,.2,.2)),this.geomItem=new t.GeomItem("Rect",this.rect,s),e&&a&&this.setParentAndXfo(e,a)}update(e){if(e.baseSize&&(this.rect.getParameter("X").setValue(e.baseSize[0]),this.rect.getParameter("Y").setValue(e.baseSize[1])),e.tr){const t=this.geomItem.getParameter("LocalXfo").getValue();t.tr.fromJSON(e.tr),this.geomItem.getParameter("LocalXfo").setValue(t)}this.emit("updated",e)}}n.registerChange("CreateRectChange",q);class Q extends Y{constructor(e,a,s,n=.001){super("CreateFreehandLine"),this.used=0,this.vertexCount=100,this.line=new t.Lines,this.line.setNumVertices(this.vertexCount),this.line.setNumSegments(this.vertexCount-1),this.line.getVertexAttribute("positions").setValue(0,new t.Vec3),this.line.lineThickness=n;const r=new t.Material("freeHandLine","FatLinesShader");r.getParameter("LineThickness").setValue(n),s&&r.getParameter("BaseColor").setValue(s),this.geomItem=new t.GeomItem("freeHandLine",this.line,r),e&&a&&this.setParentAndXfo(e,a)}update(e){this.used++;let t=!1;this.used>=this.line.getNumSegments()&&(this.vertexCount=this.vertexCount+100,this.line.setNumVertices(this.vertexCount),this.line.setNumSegments(this.vertexCount-1),t=!0),this.line.getVertexAttribute("positions").setValue(this.used,e.point),this.line.setSegmentVertexIndices(this.used-1,this.used-1,this.used),t?this.line.emit("geomDataTopologyChanged",{topologyChanged:!0}):this.line.emit("geomDataChanged",{topologyChanged:!0}),this.emit("updated",e)}toJSON(e){const t=super.toJSON(e);t.lineThickness=this.line.lineThickness;const a=this.geomItem.getParameter("Material").getValue();return t.color=a.getParameter("BaseColor").getValue(),t}fromJSON(e,a){if(e.lineThickness&&(this.line.lineThickness=e.lineThickness,this.geomItem.getMaterial().getParameter("LineThickness").setValue(e.lineThickness)),e.color){const a=new t.Color(.7,.2,.2);a.fromJSON(e.color),this.geomItem.getMaterial().getParameter("BaseColor").setValue(a)}super.fromJSON(e,a)}}n.registerChange("CreateFreehandLineChange",Q);class ee extends Y{constructor(e,a,s){super("CreateSphere",e),this.sphere=new t.Sphere(0,24,12);const n=new t.Material("Sphere","SimpleSurfaceShader");this.geomItem=new t.GeomItem("Sphere",this.sphere,n),e&&a&&s&&(n.getParameter("BaseColor").setValue(s),this.setParentAndXfo(e,a))}update(e){this.sphere.getParameter("Radius").setValue(e.radius),this.emit("updated",e)}toJSON(){const e=super.toJSON();return e.radius=this.sphere.getParameter("Radius").getValue(),e}updateFromJSON(e){e.radius&&this.sphere.getParameter("Radius").setValue(e.radius)}}n.registerChange("CreateSphereChange",ee);class te extends Y{constructor(e,a,s){super("CreateCuboid"),this.cuboid=new t.Cuboid(0,0,0,!0);const n=new t.Material("Cuboid","SimpleSurfaceShader");this.geomItem=new t.GeomItem("Cuboid",this.cuboid,n),e&&a&&(n.getParameter("BaseColor").setValue(s),this.setParentAndXfo(e,a))}update(e){if(e.baseSize&&this.cuboid.setBaseSize(e.baseSize[0],e.baseSize[1]),e.tr){const t=this.geomItem.getParameter("LocalXfo").getValue();t.tr.fromJSON(e.tr),this.geomItem.getParameter("LocalXfo").setValue(t)}e.height&&this.cuboid.getParameter("Z").setValue(e.height),this.emit("updated",e)}}n.registerChange("CreateCuboidChange",te);class ae extends t.BaseTool{constructor(){super(),this.tools={},this.toolStack=[]}registerTool(e,t){this.tools[e]=t}pushTool(e){const t=this.tools[e];if(!t)throw Error("Tool not found",e);t.activateTool&&t.activateTool(),this.toolStack.push(this.tools[e])}popTool(){if(0==this.toolStack.length)throw Error("Tool stack is empty");const e=this.toolStack[this.toolStack.length-1];e.deactivateTool&&e.deactivateTool(),this.toolStack.pop()}activeTool(){return this.toolStack.length>0?this.toolStack[this.toolStack.length-1]:""}activeToolName(){if(this.toolStack.length>0){const e=this.toolStack[this.toolStack.length-1];for(const t in this.tools)if(this.tools[t]==e)return t}return""}onPointerDown(e){for(let t=this.toolStack.length-1;t>=0;t--){const a=this.toolStack[t];if(a.onPointerDown&&(a.onPointerDown(e),!e.propagating))break}}onPointerMove(e){for(let t=this.toolStack.length-1;t>=0;t--){const a=this.toolStack[t];if(a.onPointerMove&&(a.onPointerMove(e),!e.propagating))break}}onPointerUp(e){for(let t=this.toolStack.length-1;t>=0;t--){const a=this.toolStack[t];if(a.onPointerUp&&(a.onPointerUp(e),!e.propagating))break}}onPointerDoublePress(e){for(let t=this.toolStack.length-1;t>=0;t--){const a=this.toolStack[t];if(a.onPointerDoublePress&&(a.onPointerDoublePress(e),!e.propagating))break}}onWheel(e){for(let t=this.toolStack.length-1;t>=0;t--){const a=this.toolStack[t];if(a.onWheel&&(a.onWheel(e),!e.propagating))break}}onKeyPressed(e){for(let t=this.toolStack.length-1;t>=0;t--){const a=this.toolStack[t];if(a.onKeyPressed&&(a.onKeyPressed(e),!e.propagating))break}}onKeyDown(e){for(let t=this.toolStack.length-1;t>=0;t--){const a=this.toolStack[t];if(a.onKeyDown&&(a.onKeyDown(e),!e.propagating))break}}onKeyUp(e){for(let t=this.toolStack.length-1;t>=0;t--){const a=this.toolStack[t];if(a.onKeyUp&&(a.onKeyUp(e),!e.propagating))break}}}class se extends s{constructor(e,a=.5,s=.02,n=new t.Color("#F9CE03")){super(e),this.lengthParam=this.addParameter(new t.NumberParameter("Length",a)),this.handleRadiusParam=this.addParameter(new t.NumberParameter("HandleRadius",s)),this.barRadiusParam=this.addParameter(new t.NumberParameter("BarRadius",.25*s)),this.colorParam.setValue(n),this.handleMat=new t.Material("handle","FlatSurfaceShader"),this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue());const r=new t.Material("topBar","FlatSurfaceShader");r.getParameter("BaseColor").setValue(new t.Color(.5,.5,.5));const i=new t.Cylinder(.25*s,1,64,2,!0,!0),o=new t.Sphere(s,64);this.handle=new t.GeomItem("handle",o,this.handleMat),this.baseBar=new t.GeomItem("baseBar",i,this.handleMat),this.topBar=new t.GeomItem("topBar",i,r),this.handleXfo=new t.Xfo,this.baseBarXfo=new t.Xfo,this.topBarXfo=new t.Xfo,this.barRadiusParam.on("valueChanged",(()=>{i.getParameter("Radius").setValue(this.barRadiusParam.getValue())})),this.handleRadiusParam.on("valueChanged",(()=>{o.getParameter("Radius").setValue(this.handleRadiusParam.getValue())})),this.lengthParam.on("valueChanged",(()=>{this.__updateSlider(this.value)})),this.colorParam.on("valueChanged",(()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())})),this.addChild(this.handle),this.addChild(this.baseBar),this.addChild(this.topBar),this.__updateSlider(0)}highlight(){super.highlight(),this.handleMat.getParameter("BaseColor").setValue(this.highlightColorParam.getValue())}unhighlight(){super.unhighlight(),this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}setTargetParam(e){this.param=e;const t=()=>{this.__updateSlider(e.getValue())};t(),e.on("valueChanged",t)}__updateSlider(e){this.value=e;const a=this.param&&this.param.getRange()?this.param.getRange():[0,1],s=t.MathFunctions.remap(e,a[0],a[1],0,1),n=this.lengthParam.getValue();this.baseBarXfo.sc.z=s*n,this.handleXfo.tr.z=s*n,this.topBarXfo.tr.z=s*n,this.topBarXfo.sc.z=(1-s)*n,this.handle.getParameter("LocalXfo").setValue(this.handleXfo),this.baseBar.getParameter("LocalXfo").setValue(this.baseBarXfo),this.topBar.getParameter("LocalXfo").setValue(this.topBarXfo)}onDragStart(e){this.handleXfo.sc.x=this.handleXfo.sc.y=this.handleXfo.sc.z=1.2,this.handle.getParameter("LocalXfo").setValue(this.handleXfo),this.param&&(this.change=new o(this.param),n.getInstance().addChange(this.change))}onDrag(e){const a=this.lengthParam.getValue(),s=this.param&&this.param.getRange()?this.param.getRange():[0,1],n=t.MathFunctions.clamp(t.MathFunctions.remap(e.value,0,a,s[0],s[1]),s[0],s[1]);if(!this.param)return this.__updateSlider(n),void(this.value=n);this.change.update({value:n})}onDragEnd(e){this.change=null,this.handleXfo.sc.x=this.handleXfo.sc.y=this.handleXfo.sc.z=1,this.handle.getParameter("LocalXfo").setValue(this.handleXfo)}toJSON(e){const t=super.toJSON(e);return this.param&&(t.targetParam=this.param.getPath()),t}fromJSON(e,t){super.fromJSON(e,t),e.targetParam&&t.resolvePath(e.targetParam).then((e=>{this.setTargetParam(e)}))}}t.Registry.register("SliderHandle",se);class ne extends g{constructor(e,a=1,s=1,n=.02,r=new t.Color(1,1,0)){super(e),this.arcRadiusParam=this.addParameter(new t.NumberParameter("ArcRadius",a)),this.arcAngleParam=this.addParameter(new t.NumberParameter("ArcAngle",s)),this.handleRadiusParam=this.addParameter(new t.NumberParameter("HandleRadius",n)),this.colorParam.setValue(r),this.handleMat=new t.Material("handleMat","HandleShader"),this.handleMat.getParameter("BaseColor").setValue(r);const i=new t.Circle(a,64,s),o=new t.Sphere(n,64);this.handle=new t.GeomItem("handle",o,this.handleMat),this.arc=new t.GeomItem("arc",i,this.handleMat),this.handleXfo=new t.Xfo,this.handleGeomOffsetXfo=new t.Xfo,this.handleGeomOffsetXfo.tr.x=a,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.range=[0,s],this.arcAngleParam.on("valueChanged",(()=>{const e=this.arcAngleParam.getValue();i.getParameter("Angle").setValue(e),this.range=[0,e]})),this.arcRadiusParam.on("valueChanged",(()=>{const e=this.arcRadiusParam.getValue();i.getParameter("Radius").setValue(e),this.handleGeomOffsetXfo.tr.x=e,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo)})),this.handleRadiusParam.on("valueChanged",(()=>{o.getParameter("Radius").setValue(this.handleRadiusParam.getValue())})),this.colorParam.on("valueChanged",(()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())})),this.addChild(this.handle),this.addChild(this.arc),this.setTargetParam(this.handle.getParameter("GlobalXfo"),!1)}onPointerEnter(e){e.intersectionData&&e.intersectionData.geomItem==this.handle&&this.highlight()}onPointerLeave(e){this.unhighlight()}onPointerDown(e){e.intersectionData&&e.intersectionData.geomItem==this.handle&&super.onPointerDown(e)}highlight(){super.highlight(),this.handleMat.getParameter("BaseColor").setValue(this.highlightColorParam.getValue())}unhighlight(){super.unhighlight(),this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}setTargetParam(e,a=!0){if(this.param=e,a)if(this.param instanceof t.XfoParameter){const t=()=>{this.getParameter("GlobalXfo").setValue(e.getValue())};t(),e.on("valueChanged",t)}else if(this.param instanceof t.NumberParameter){const a=()=>{this.handleXfo.ori.setFromAxisAndAngle(new t.Vec3(0,0,1),e.getValue()),this.handle.getParameter("GlobalXfo").setValue(this.handleXfo)};a(),e.on("valueChanged",a)}}getBaseXfo(){return this.handle.getParameter("GlobalXfo").getValue()}onDragStart(e){this.baseXfo=this.getParameter("GlobalXfo").getValue().clone(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new t.Xfo,this.vec0=this.getParameter("GlobalXfo").getValue().ori.getXaxis(),this.vec0.normalizeInPlace(),this.change=new o(this.param),n.getInstance().addChange(this.change),this.handleGeomOffsetXfo.sc.x=this.handleGeomOffsetXfo.sc.y=this.handleGeomOffsetXfo.sc.z=1.2,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.emit("dragStart")}onDrag(e){const a=e.holdPos.subtract(this.baseXfo.tr);a.normalizeInPlace();let s=this.vec0.angleTo(a);if(this.vec0.cross(a).dot(this.baseXfo.ori.getZaxis())<0&&(s=-s),this.range&&(s=t.MathFunctions.clamp(s,this.range[0],this.range[1])),e.shiftKey){const e=Math.degToRad(22.5);s=Math.floor(s/e)*e}this.deltaXfo.ori.setFromAxisAndAngle(new t.Vec3(0,0,1),s);const n=this.baseXfo.multiply(this.deltaXfo);this.change?this.param instanceof t.XfoParameter?this.change.update({value:n}):this.param instanceof t.NumberParameter&&this.change.update({value:s}):this.param instanceof t.XfoParameter?this.param.setValue(n):this.param instanceof t.NumberParameter&&this.param.setValue(s)}onDragEnd(e){this.change=null,this.handleGeomOffsetXfo.sc.x=this.handleGeomOffsetXfo.sc.y=this.handleGeomOffsetXfo.sc.z=1,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.emit("dragEnd")}toJSON(e){const t=super.toJSON(e);return this.param&&(t.targetParam=this.param.getPath()),t}fromJSON(e,t){super.fromJSON(e,t),e.targetParam&&t.resolvePath(e.targetParam).then((e=>{this.setTargetParam(e)}))}}t.Registry.register("ArcSlider",ne);class re extends a{constructor(e){super(e)}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.getParameter("GlobalXfo").setValue(e.getValue())};t(),e.on("valueChanged",t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}handlePointerDown(e){this.gizmoRay=new t.Ray;const a=e.pointerRay,s=e.viewport.getCamera().getParameter("GlobalXfo").getValue();this.gizmoRay.dir=s.ori.getZaxis();const n=this.getTargetParam().getValue();this.gizmoRay.start=n.tr;const r=a.intersectRayPlane(this.gizmoRay);return e.grabPos=a.pointAtDist(r),this.onDragStart(e),!0}handlePointerMove(e){const t=e.pointerRay,a=t.intersectRayPlane(this.gizmoRay);return e.holdPos=t.pointAtDist(a),this.onDrag(e),!0}handlePointerUp(e){const t=e.pointerRay;if(t){const a=t.intersectRayPlane(this.gizmoRay);e.releasePos=t.pointAtDist(a)}return this.onDragEnd(e),!0}onDragStart(e){this.grabPos=e.grabPos;const t=this.getTargetParam();this.baseXfo=t.getValue(),this.change=new o(t),n.getInstance().addChange(this.change)}onDrag(e){const t=e.holdPos.subtract(this.grabPos),a=this.baseXfo.clone();a.tr.addInPlace(t),this.change.update({value:a})}onDragEnd(e){this.change=null}}const ie={StartXfo:"StartXfo",EndXfo:"EndXfo",Distance:"Distance",LabelXfo:"LabelXfo",LineXfo:"LineXfo"};class oe extends t.Operator{constructor(e){super(e),this.unitsParameter=this.addParameter(new t.StringParameter("Units","mm")),this.unitsParameter.on("valueChange",(()=>console.log("Units Changed"))),this.addInput(new t.OperatorInput(ie.StartXfo)),this.addInput(new t.OperatorInput(ie.EndXfo)),this.addOutput(new t.OperatorOutput(ie.Distance)),this.addOutput(new t.OperatorOutput(ie.LabelXfo)),this.addOutput(new t.OperatorOutput(ie.LineXfo))}evaluate(){const e=this.getInput(ie.StartXfo).getValue(),a=this.getInput(ie.EndXfo).getValue(),s=this.getOutput(ie.Distance),n=this.getOutput(ie.LabelXfo),r=this.getOutput(ie.LineXfo),i=a.tr.subtract(e.tr),o=i.length();i.normalizeInPlace();const l=e.tr.add(i.scale(.5*o));s.setClean(`${parseFloat(o.toFixed(4))}${this.unitsParameter.getValue()}`);const h=new t.Xfo(l);h.ori.setFromDirectionAndUpvector(i,new t.Vec3(i.z,i.x,i.y)),n.setClean(h);const c=e.clone();c.ori.setFromDirectionAndUpvector(i,new t.Vec3(i.z,i.x,i.y)),c.sc.z=o,r.setClean(c)}static get IO_NAMES(){return ie}}t.Registry.register("MeasurementOperator",oe);class le extends re{handlePointerMove(e){const t=e.pointerRay;if(e.intersectionData=e.viewport.getGeomDataAtPos(e.pointerPos,e.pointerRay),e.intersectionData)e.holdPos=t.start.add(t.dir.scale(e.intersectionData.dist));else{const a=t.intersectRayPlane(this.gizmoRay);e.holdPos=t.pointAtDist(a)}return this.onDrag(e),!0}onDragStart(e){super.onDragStart(e),this.getOwner().traverse((e=>{e instanceof t.GeomItem&&(e.getParameter("Material").getValue().visibleInGeomDataBuffer=!1)})),e.viewport.renderGeomDataFbo()}onDrag(e){const t=this.baseXfo.clone();t.tr=e.holdPos,this.change.update({value:t})}onDragEnd(e){super.onDragEnd(e),this.getOwner().traverse((e=>{e instanceof t.GeomItem&&(e.getParameter("Material").getValue().visibleInGeomDataBuffer=!0)})),e.viewport.renderGeomDataFbo()}}t.Registry.register("MeasurementHandle",le);class he extends t.TreeItem{constructor(e="Measurement",a=new t.Color("#FCFC00")){super(e),this.colorParam=this.addParameter(new t.ColorParameter("Color",a)),this.markerMaterial=new t.Material("Marker","HandleShader"),this.markerMaterial.getParameter("BaseColor").setValue(this.colorParam.getValue()),this.markerMaterial.getParameter("MaintainScreenSize").setValue(1),this.markerMaterial.getParameter("Overlay").setValue(.5),this.lineMaterial=new t.Material("Line","LinesShader"),this.lineMaterial.getParameter("BaseColor").setValue(this.colorParam.getValue()),this.lineMaterial.getParameter("Overlay").setValue(.5);const s=new t.Sphere(.003);this.startMarker=new t.GeomItem(`${e}StartMarker`,s,this.markerMaterial),this.endMarker=new t.GeomItem(`${e}EndMarker`,s,this.markerMaterial),this.startMarkerHandle=new le("StartMarkerHandle"),this.startMarkerHandle.addChild(this.startMarker),this.addChild(this.startMarkerHandle),this.endMarkerHandle=new le("EndMarkerHandle"),this.endMarkerHandle.addChild(this.endMarker),this.addChild(this.endMarkerHandle),this.label=new t.Label("Distance"),this.label.getParameter("FontSize").setValue(20),this.label.getParameter("BackgroundColor").setValue(this.colorParam.getValue());const n=new t.BillboardItem("DistanceBillboard",this.label);n.getParameter("LocalXfo").setValue(new t.Xfo),n.getParameter("PixelsPerMeter").setValue(1500),n.getParameter("AlignedToCamera").setValue(!0),n.getParameter("DrawOnTop").setValue(!0),n.getParameter("FixedSizeOnscreen").setValue(!0),n.getParameter("Alpha").setValue(1),this.addChild(n);const r=new t.Lines(0);r.setNumVertices(2),r.setNumSegments(1),r.setSegmentVertexIndices(0,0,1),r.getVertexAttribute("positions").getValueRef(1).setFromOther(new t.Vec3(0,0,1));const i=new t.GeomItem("Line",r,this.lineMaterial);this.addChild(i);const o=new oe(`${e}MeasurementOperator`);o.getInput(oe.IO_NAMES.StartXfo).setParam(this.startMarkerHandle.getParameter("GlobalXfo")),o.getInput(oe.IO_NAMES.EndXfo).setParam(this.endMarkerHandle.getParameter("GlobalXfo")),o.getOutput(oe.IO_NAMES.Distance).setParam(this.label.getParameter("Text")),o.getOutput(oe.IO_NAMES.LabelXfo).setParam(n.getParameter("GlobalXfo")),o.getOutput(oe.IO_NAMES.LineXfo).setParam(i.getParameter("GlobalXfo")),this.colorParam.on("valueChanged",(()=>{const e=this.colorParam.getValue();this.markerMaterial.getParameter("BaseColor").setValue(e),this.lineMaterial.getParameter("BaseColor").setValue(e),this.label.getParameter("BackgroundColor").setValue(e)}))}setStartMarkerPos(e){const t=this.startMarkerHandle.getParameter("GlobalXfo").getValue();t.tr=e,this.startMarkerHandle.getParameter("GlobalXfo").setValue(t)}setEndMarkerPos(e){const t=this.endMarkerHandle.getParameter("GlobalXfo").getValue();t.tr=e,this.endMarkerHandle.getParameter("GlobalXfo").setValue(t)}setGeomBuffersVisibility(e){this.markerMaterial.visibleInGeomDataBuffer=e,this.lineMaterial.visibleInGeomDataBuffer=e}getMeasurementText(){return this.label.getParameter("Text").getValue()}}t.Registry.register("Measurement",he);class ce extends i{constructor(e,t,a){super("MeasurementChange"),this.parentItem=e,this.measurement=new he("Measurement",a),this.measurement.setStartMarkerPos(t),this.measurement.setEndMarkerPos(t),this.measurement.setGeomBuffersVisibility(!1),this.childIndex=this.parentItem.getChildIndex(this.parentItem.addChild(this.measurement))}update(e){e.startPos&&this.measurement.setStartMarkerPos(e.startPos),e.endPos&&this.measurement.setEndMarkerPos(e.endPos),this.emit("updated",e)}end(){this.measurement.setGeomBuffersVisibility(!0)}undo(){console.log("undo MeasurementChange"),this.parentItem.removeChild(this.childIndex)}redo(){console.log("redo MeasurementChange"),this.parentItem.addChild(this.measurement,!1,!1)}toJSON(e){const t=super.toJSON(e);return t.parentItemPath=this.parentItem.getPath(),t.name=this.measurement.getName(),t.startMarker=this.measurement.startMarker.toJSON(),t.endMarker=this.measurement.startMarker.toJSON(),t}fromJSON(e,a){const s=a.appData.scene.getRoot();this.parentItem=s.resolvePath(e.parentItemPath,1),this.measurement.setName(this.parentItem.generateUniqueName(e.name));const n=new t.Xfo;n.fromJSON(e.startMarker),this.measurement.setStartMarkerPos(n),this.childIndex=this.parentItem.getChildIndex(this.parentItem.addChild(this.measurement))}destroy(){}}n.registerChange("MeasurementChange",ce);class ge extends t.BaseTool{constructor(e){super(),this.colorParam=this.addParameter(new t.ColorParameter("Color",new t.Color("#FCFC00"))),e||console.error("App data not provided to tool"),this.appData=e,this.measurementChange=void 0}activateTool(){super.activateTool(),this.appData&&this.appData.renderer&&(this.prevCursor=this.appData.renderer.getGLCanvas().style.cursor,this.appData.renderer.getGLCanvas().style.cursor="crosshair")}deactivateTool(){super.deactivateTool(),this.appData&&this.appData.renderer&&(this.appData.renderer.getGLCanvas().style.cursor=this.prevCursor)}onPointerDown(e){if(e.altKey||"mouse"===e.pointerType&&0!==e.button)return;const a=e.pointerRay;let s;if(e.intersectionData)s=a.start.add(a.dir.scale(e.intersectionData.dist));else{const e=new t.Ray(new t.Vec3,new t.Vec3(0,0,1)),n=a.intersectRayPlane(e);s=a.start.add(a.dir.scale(n))}const r=this.colorParam.getValue();this.measurementChange=new ce(this.appData.scene.getRoot(),s,r),n.getInstance().addChange(this.measurementChange),this.dragging=!0,e.stopPropagation()}onPointerMove(e){if(this.dragging){const a=e.pointerRay;let s;if(e.intersectionData)s=a.start.add(a.dir.scale(e.intersectionData.dist));else{const e=new t.Ray(new t.Vec3,new t.Vec3(0,0,1)),n=a.intersectRayPlane(e);s=a.start.add(a.dir.scale(n))}this.measurementChange.update({endPos:s}),e.stopPropagation()}}onPointerUp(e){this.dragging&&(this.dragging=!1,this.measurementChange.end(),this.measurementChange=void 0,e.stopPropagation())}}e.ArcSlider=ne,e.AxialRotationHandle=u,e.Change=i,e.CreateCircleChange=$,e.CreateCircleTool=class extends j{constructor(e){super(e)}createStart(e){this.change=new $(this.parentItem,e),n.getInstance().addChange(this.change),this.xfo=e,this.stage=1,this.radius=0}createMove(e){this.radius=e.distanceTo(this.xfo.tr),this.change.update({radius:this.radius}),this.appData.renderer.forceRender()}createRelease(e){0==this.radius&&n.getInstance().cancel(),this.change=null,this.stage=0,this.emit("actionFinished")}},e.CreateConeChange=Z,e.CreateConeTool=class extends j{constructor(e){super(e)}createStart(e){this.xfo=e,this.invXfo=e.inverse(),this.change=new Z(this.parentItem,e,this.colorParam.getValue()),n.getInstance().addChange(this.change),this.stage=1,this._radius=0,this._height=0}createMove(e){if(1==this.stage){const t=e.subtract(this.xfo.tr);this._radius=t.length(),this.change.update({radius:this._radius})}else this._height=this.invXfo.transformVec3(e).y,this.change.update({height:this._height})}createRelease(e){if(0==this._radius&&(n.getInstance().cancel(),this.stage=0,this.emit("actionFinished")),1==this.stage){this.stage=2;const a=new t.Quat;a.setFromAxisAndAngle(new t.Vec3(1,0,0),.5*Math.PI),this.constructionPlane.ori=this.constructionPlane.ori.multiply(a),this.constructionPlane.tr=e,this.invXfo=this.constructionPlane.inverse()}else 2==this.stage&&(this.stage=0,this.emit("actionFinished"))}},e.CreateCuboidChange=te,e.CreateCuboidTool=class extends j{constructor(e){super(e)}createStart(e){this.change=new te(this.parentItem,e,this.colorParam.getValue()),n.getInstance().addChange(this.change),this.xfo=e,this.invXfo=e.inverse(),this.stage=1,this._height=0}createMove(e){if(1==this.stage){const t=this.invXfo.transformVec3(e);this.change.update({baseSize:[Math.abs(t.x),Math.abs(t.y)],tr:this.xfo.tr.add(t.scale(.5))})}else{const t=this.invXfo.transformVec3(e);this.change.update({height:t.y})}}createRelease(e){if(1==this.stage){this.stage=2,this.pt1=e;const a=new t.Quat;a.setFromAxisAndAngle(new t.Vec3(1,0,0),.5*Math.PI),this.constructionPlane.ori=this.constructionPlane.ori.multiply(a),this.constructionPlane.tr=e,this.invXfo=this.constructionPlane.inverse()}else 2==this.stage&&(this.stage=0,this.emit("actionFinished"))}},e.CreateFreehandLineChange=Q,e.CreateFreehandLineTool=class extends K{constructor(e){super(e),this.mp=this.addParameter(new t.BooleanParameter("Modulate Thickness By Stroke Speed",!1))}createStart(e){const t=this.colorParam.getValue(),a=this.lineThickness.getValue();this.change=new Q(this.parentItem,e,t,a),n.getInstance().addChange(this.change),this.xfo=e,this.invXfo=e.inverse(),this.stage=1,this.prevP=e.tr,this.length=0}createMove(e){const t=this.invXfo.transformVec3(e),a=t.subtract(this.prevP).length();this.change.update({point:t}),this.length+=a,this.prevP=t}createRelease(e){0==this.length&&n.getInstance().cancel(),this.stage=0,this.emit("actionFinished")}},e.CreateLineChange=W,e.CreateLineTool=K,e.CreateRectChange=q,e.CreateRectTool=class extends j{constructor(e){super(e)}createStart(e){this.change=new q(this.parentItem,e),n.getInstance().addChange(this.change),this.xfo=e,this.invXfo=e.inverse(),this.stage=1,this._size=0}createMove(e){if(1==this.stage){const t=this.invXfo.transformVec3(e);this._size=Math.abs(t.x),Math.abs(t.y),this.change.update({baseSize:[Math.abs(t.x),Math.abs(t.y)],tr:this.xfo.tr.add(t.scale(.5))})}else{const t=this.invXfo.transformVec3(e);this.change.update({height:t.y})}}createRelease(e){0==this._size&&n.getInstance().cancel(),this.stage=0,this.emit("actionFinished")}},e.CreateSphereChange=ee,e.CreateSphereTool=class extends j{constructor(e){super(e)}createStart(e){this.change=new ee(this.parentItem,e,this.colorParam.getValue()),n.getInstance().addChange(this.change),this.xfo=e,this.stage=1,this.radius=0}createMove(e){this.radius=e.distanceTo(this.xfo.tr),this.change.update({radius:this.radius})}createRelease(e){0==this.radius&&n.getInstance().cancel(),this.stage=0,this.emit("actionFinished")}},e.LinearMovementHandle=c,e.Measurement=he,e.MeasurementChange=ce,e.MeasurementOperator=oe,e.MeasurementTool=ge,e.ParameterValueChange=o,e.PlanarMovementHandle=d,e.ScreenSpaceMovementHandle=re,e.SelectionChange=I,e.SelectionManager=w,e.SelectionTool=b,e.SelectionVisibilityChange=C,e.SliderHandle=se,e.ToolManager=ae,e.TreeItemAddChange=v,e.TreeItemMoveChange=S,e.TreeItemsRemoveChange=V,e.UndoRedoManager=n,e.VRHoldObjectsTool=F,e.VRUITool=U,e.XfoHandle=p,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=index.umd.js.map
